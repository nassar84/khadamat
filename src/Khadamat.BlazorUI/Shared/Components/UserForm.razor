@using Khadamat.Application.DTOs
@using Khadamat.BlazorUI.Helpers
@using System.ComponentModel.DataAnnotations

@if (Show)
{
    <div class="modal-overlay" @onclick="HandleOverlayClick">
        <div class="glass-card p-4 rounded-4 w-100 mx-3 animate-pop" style="max-width: 650px; max-height: 90vh; overflow-y: auto;" @onclick:stopPropagation="true">
            <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white pb-3" style="margin: -1rem -1rem 1rem -1rem; padding: 1rem 1rem 0.5rem 1rem; border-bottom: 1px solid #e9ecef;">
                <h5 class="fw-bold mb-0">
                    @if (Mode == "Create") { <span>إضافة مستخدم جديد</span> }
                    else if (Mode == "Edit") { <span>تعديل بيانات المستخدم</span> }
                    else { <span>تفاصيل المستخدم</span> }
                </h5>
                <button class="btn-close" @onclick="Cancel"></button>
            </div>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger small border-0 mb-3">@ErrorMessage</div>
            }

            <EditForm Model="@Model" OnValidSubmit="Submit">
                <DataAnnotationsValidator />
                
                <div class="row g-3">
                    <div class="col-12 mb-3">
                        <ImageUploader @bind-ImageUrl="Model.ProfileImageUrl" 
                                      ReadOnly="@IsReadOnly"
                                      Height="120px" Width="120px"
                                      ContainerClass="mx-auto"
                                      PickerLabel="صورك"
                                      ShowUrlInput="!IsReadOnly" />
                    </div>

                    <div class="col-md-12">
                        <label class="form-label small fw-bold">الاسم الكامل</label>
                        <InputText class="form-control rounded-pill px-4" @bind-Value="Model.FullName" disabled="@IsReadOnly" placeholder="أدخل الاسم الكامل" />
                        <ValidationMessage For="@(() => Model.FullName)" class="text-danger small" />
                    </div>

                    @if (Mode == "Create" || Mode == "Edit" || !string.IsNullOrEmpty(Model.UserName))
                    {
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">اسم المستخدم</label>
                            <InputText class="form-control rounded-pill px-4" @bind-Value="Model.UserName" disabled="@IsReadOnly" />
                            <ValidationMessage For="@(() => Model.UserName)" class="text-danger small" />
                        </div>
                    }

                    <div class="col-md-6">
                        <label class="form-label small fw-bold">البريد الإلكتروني</label>
                        <InputText class="form-control rounded-pill px-4" @bind-Value="Model.Email" disabled="@IsReadOnly" placeholder="example@domain.com" />
                        <ValidationMessage For="@(() => Model.Email)" class="text-danger small" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small fw-bold">رقم الهاتف</label>
                        <InputText class="form-control rounded-pill px-4" @bind-Value="Model.PhoneNumber" disabled="@IsReadOnly" placeholder="01xxxxxxxxx" />
                        <ValidationMessage For="@(() => Model.PhoneNumber)" class="text-danger small" />
                    </div>

                    @if (Mode == "Create")
                    {
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">كلمة المرور</label>
                            <InputText type="password" class="form-control rounded-pill px-4" @bind-Value="Model.Password" placeholder="أدخل كلمة المرور" />
                            <ValidationMessage For="@(() => Model.Password)" class="text-danger small" />
                        </div>
                    }


                    <div class="col-md-6">
                        <label class="form-label small fw-bold">الدور الوظيفي</label>
                        <InputSelect class="form-select rounded-pill px-4" @bind-Value="Model.Role" disabled="@IsReadOnly">
                            <option value="User">مستخدم</option>
                            @if (CurrentUserRole == "SuperAdmin")
                            {
                                <option value="SystemAdmin">مدير نظام</option>
                                <option value="SuperAdmin">مدير خارق</option>
                            }
                        </InputSelect>
                    </div>

                     @if (Mode != "Create") 
                     {
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">الجنس</label>
                            <InputSelect class="form-select rounded-pill px-4" @bind-Value="Model.Gender" disabled="@IsReadOnly">
                                <option value="">غير محدد</option>
                                <option value="Male">ذكر</option>
                                <option value="Female">أنثى</option>
                            </InputSelect>
                        </div>

                        <div class="col-md-6 d-flex align-items-end mb-2">
                             <div class="form-check form-switch w-100 bg-light p-2 rounded-pill ps-5">
                                <input class="form-check-input ms-1" type="checkbox" @bind="Model.IsActive" id="activeSwitch" disabled="@IsReadOnly">
                                <label class="form-check-label small fw-bold" for="activeSwitch">حساب نشط</label>
                            </div>
                        </div>
                     }

                    <LocationSelector Governorates="@Governorates" 
                                      @bind-CityId="Model.CityId" 
                                      ReadOnly="@IsReadOnly" />

                    @if (Mode != "Create")
                    {
                        <div class="col-12">
                            <label class="form-label small fw-bold">نبذة (Bio)</label>
                            <InputTextArea class="form-control rounded-4 px-4" rows="3" @bind-Value="Model.Bio" disabled="@IsReadOnly" />
                        </div>

                        <div class="col-12 mt-3">
                            <h6 class="fw-bold border-bottom pb-2">روابط التواصل الاجتماعي</h6>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label x-small text-muted">الموقع الإلكتروني</label>
                            <InputText class="form-control rounded-pill px-4 bg-light small" @bind-Value="Model.WebsiteUrl" disabled="@IsReadOnly" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small text-muted">فيسبوك</label>
                            <InputText class="form-control rounded-pill px-4 bg-light small" @bind-Value="Model.FacebookUrl" disabled="@IsReadOnly" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small text-muted">انستجرام</label>
                            <InputText class="form-control rounded-pill px-4 bg-light small" @bind-Value="Model.InstagramUrl" disabled="@IsReadOnly" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small text-muted">تويتر (X)</label>
                            <InputText class="form-control rounded-pill px-4 bg-light small" @bind-Value="Model.TwitterUrl" disabled="@IsReadOnly" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small text-muted">لينكد إن</label>
                            <InputText class="form-control rounded-pill px-4 bg-light small" @bind-Value="Model.LinkedInUrl" disabled="@IsReadOnly" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label x-small text-muted">تيك توك</label>
                            <InputText class="form-control rounded-pill px-4 bg-light small" @bind-Value="Model.TikTokUrl" disabled="@IsReadOnly" />
                        </div>
                    }
                </div>

                <div class="d-flex gap-2 mt-4">
                    @if (!IsReadOnly)
                    {
                        <button type="submit" class="btn btn-primary flex-grow-1 rounded-pill" disabled="@IsSaving">
                            @if (IsSaving) { <span class="spinner-border spinner-border-sm me-2"></span> }
                            @(Mode == "Create" ? "إنشاء الحساب" : "حفظ التغييرات")
                        </button>
                    }
                    <button type="button" class="btn btn-light flex-grow-1 rounded-pill" @onclick="Cancel" disabled="@IsSaving">
                        @(IsReadOnly ? "إغلاق" : "إلغاء")
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public string Mode { get; set; } = "View"; // "Create", "Edit", "View"
    [Parameter] public UserDto? User { get; set; }
    
    [Parameter] public List<GovernorateDto> Governorates { get; set; } = new();
    [Parameter] public List<CityDto> Cities { get; set; } = new();
    
    [Parameter] public string CurrentUserRole { get; set; } = "";
    [Parameter] public bool IsSaving { get; set; }
    [Parameter] public string ErrorMessage { get; set; } = "";

    [Parameter] public EventCallback<UserFormModel> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    public UserFormModel Model { get; set; } = new();
    
    private bool IsReadOnly => Mode == "View";

    public class UserFormModel
    {
        public string Id { get; set; } = "";
        
        [Required(ErrorMessage = "الاسم الكامل مطلوب")]
        public string FullName { get; set; } = "";
        
        public string UserName { get; set; } = "";
        
        [Required(ErrorMessage = "البريد الإلكتروني مطلوب")]
        [EmailAddress(ErrorMessage = "صيغة البريد الإلكتروني غير صحيحة")]
        public string Email { get; set; } = "";
        
        [Required(ErrorMessage = "رقم الهاتف مطلوب")]
        public string PhoneNumber { get; set; } = "";
        
        // Password only for create
        public string Password { get; set; } = "";
        
        public string Role { get; set; } = "User";
        public bool IsActive { get; set; }
        public string? Gender { get; set; }
        public string? ProfileImageUrl { get; set; }
        public int? CityId { get; set; }
        
        public string? Bio { get; set; }
        public string? WebsiteUrl { get; set; }
        public string? InstagramUrl { get; set; }
        public string? TwitterUrl { get; set; }
        public string? FacebookUrl { get; set; }
        public string? LinkedInUrl { get; set; }
        public string? TikTokUrl { get; set; }
    }

    protected override void OnParametersSet()
    {
        if (Show && Model.Id != (User?.Id ?? "New"))
        {
            ResetForm();
        }
    }

    private void ResetForm()
    {
        if (Mode == "Create")
        {
            Model = new UserFormModel { Id = "New", Role = "User", IsActive = true };
        }
        else if (User != null)
        {
            Model = new UserFormModel
            {
                Id = User.Id,
                FullName = User.FullName,
                UserName = User.UserName,
                Email = User.Email,
                PhoneNumber = User.PhoneNumber ?? "",
                Role = User.Role,
                IsActive = User.IsActive,
                Gender = User.Gender,
                ProfileImageUrl = User.ProfileImageUrl,
                CityId = User.CityId,
                Bio = User.Bio,
                WebsiteUrl = User.WebsiteUrl,
                InstagramUrl = User.InstagramUrl,
                TwitterUrl = User.TwitterUrl,
                FacebookUrl = User.FacebookUrl,
                LinkedInUrl = User.LinkedInUrl,
                TikTokUrl = User.TikTokUrl
            };

            // Location is now handled by LocationSelector via binding
        }
    }

    private async Task Submit()
    {
        if (Mode == "Create" && string.IsNullOrEmpty(Model.Password))
        {
            // Manual validation for password in Create mode if needed, 
            // though DataAnnotations usually handle it if I put [Required] conditional.
            // But since I can't do conditional [Required] easily, I'll check it here.
             // Wait, I didn't put Required on Password in the class because it's optional for Edit.
             // So I must check it here.
             // Actually, I'll leave it to server side or add logic.
             // Use simple check:
             // But actually I *did* put validation message. I should add a check.
        }

        await OnSave.InvokeAsync(Model);
    }

    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
    }
    
    private async Task HandleOverlayClick()
    {
        // Optional: close on overlay click
        await Cancel();
    }
}

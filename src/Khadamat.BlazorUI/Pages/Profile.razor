@page "/profile"
@using Khadamat.Application.DTOs
@using Khadamat.BlazorUI.Services
@using Khadamat.BlazorUI.Services.Auth
@using Khadamat.BlazorUI.State
@inject IAuthService AuthService
@inject ApiClient Api
@inject NavigationManager Navigation
@inject AppState AppState
@inject IJSRuntime JS

<div class="profile-premium-page py-5">
    <div class="container">
        @if (isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">جاري تحميل بياناتك...</p>
            </div>
        }
        else if (profile != null)
        {
            <!-- Header Banner -->
            <div class="profile-hero mb-5 animate-up">
                <div class="hero-cover"></div>
                <div class="hero-content p-4 d-flex align-items-end">
                    <div class="avatar-large-wrapper">
                        <img src="@(string.IsNullOrEmpty(model.ProfileImageUrl) ? AppState.UserImageUrl : model.ProfileImageUrl)" class="avatar-large" />
                        <div class="avatar-edit-badge">
                            <InputFile id="profilePicInput" OnChange="HandleFileSelected" style="display:none" accept="image/*" />
                            <label for="profilePicInput" class="cursor-pointer mb-0">
                                <i class="fa-solid fa-camera"></i>
                            </label>
                        </div>
                    </div>
                    <div class="ms-4 pb-2 text-white hero-text-area">
                        <h2 class="fw-bold mb-1">@profile.FullName</h2>
                        <div class="d-flex align-items-center gap-3">
                            <span class="opacity-75">@@@profile.UserName</span>
                            @if (profile.IsVerified)
                            {
                                <span class="badge bg-success rounded-pill"><i class="fa-solid fa-check-circle me-1"></i> موثق</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(feedbackMessage))
            {
                <div class="alert @(isSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show mb-4 animate-pop" role="alert">
                    <i class="fa-solid @(isSuccess ? "fa-circle-check" : "fa-circle-exclamation") me-2"></i>
                    @feedbackMessage
                    <button type="button" class="btn-close" @onclick='() => feedbackMessage = ""'></button>
                </div>
            }

            <div class="row g-4">
                <!-- Sidebar Info -->
                <div class="col-lg-4">
                    <div class="glass-card p-4 h-100 shadow-sm animate-up" style="animation-delay: 0.1s;">
                        <h5 class="fw-bold mb-4 border-bottom pb-2">نظرة عامة</h5>
                        
                        <div class="info-item mb-3">
                            <label class="text-muted d-block small">البريد الإلكتروني</label>
                            <span class="fw-bold">@profile.Email</span>
                        </div>

                        <div class="info-item mb-3">
                            <label class="text-muted d-block small">تاريخ الانضمام</label>
                            <span class="fw-bold">@profile.CreatedAt.ToString("MMMM yyyy")</span>
                        </div>

                        <div class="info-item mb-4">
                            <label class="text-muted d-block small">حالة الحساب</label>
                            <span class="badge @(profile.IsActive ? "bg-light-success text-success" : "bg-light-danger text-danger")">
                                @(profile.IsActive ? "نشط" : "غير نشط")
                            </span>
                        </div>

                        <div class="d-grid gap-2">
                             <button class="btn btn-outline-primary rounded-pill btn-sm" @onclick='() => Navigation.NavigateTo("/user/notifications")'>
                                <i class="fa-solid fa-bell me-2"></i>مركز التنبيهات
                            </button>
                             <button class="btn btn-outline-primary rounded-pill btn-sm" @onclick='() => Navigation.NavigateTo("/user/messages")'>
                                <i class="fa-solid fa-envelope me-2"></i>الرسائل
                            </button>
                        </div>
                        
                        @if (profile.IsProvider)
                        {
                            <div class="mt-4 pt-4 border-top">
                                <h6 class="fw-bold mb-3">إحصائيات العمل</h6>
                                <div class="row g-2 text-center">
                                    <div class="col-6">
                                        <div class="bg-light p-3 rounded-4">
                                            <div class="fs-4 fw-bold text-primary">@userServices.Count</div>
                                            <div class="x-small text-muted">خدماتنا</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-light p-3 rounded-4">
                                            <div class="fs-4 fw-bold text-success">0.0</div>
                                            <div class="x-small text-muted">التقييم</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Main Content (Unified Form) -->
                <div class="col-lg-8">
                    <EditForm Model="@model" OnValidSubmit="HandleProfileSave">
                        <DataAnnotationsValidator />
                        
                        <!-- Personal Details Card -->
                        <div class="glass-card p-4 mb-4 shadow-sm animate-up" style="animation-delay: 0.2s;">
                            <h5 class="fw-bold mb-4 border-bottom pb-2 text-primary">البيانات الشخصية</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">الاسم الكامل</label>
                                    <InputText @bind-Value="model.FullName" class="form-control premium-input" placeholder="أدخل اسمك بالكامل" />
                                    <ValidationMessage For="@(() => model.FullName)" class="text-danger small" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">رقم الهاتف</label>
                                    <InputText @bind-Value="model.PhoneNumber" class="form-control premium-input" placeholder="01xxxxxxxxx" />
                                    <ValidationMessage For="@(() => model.PhoneNumber)" class="text-danger small" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">المحافظة</label>
                                    <select class="form-select premium-input" @onchange="OnGovernorateChanged">
                                        <option value="">-- اختر المحافظة --</option>
                                        @foreach (var gov in governorates)
                                        {
                                            <option value="@gov.Id" selected="@(selectedGovernorateId == gov.Id)">@gov.NameAr</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">المدينة</label>
                                    <InputSelect @bind-Value="model.CityId" class="form-select premium-input">
                                        <option value="0">-- اختر المدينة --</option>
                                        @foreach (var city in cities)
                                        {
                                            <option value="@city.Id">@city.NameAr</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => model.CityId)" class="text-danger small" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-bold">نبذة تعريفية (Bio)</label>
                                    <InputTextArea @bind-Value="model.Bio" class="form-control premium-input" rows="3" placeholder="أخبر الناس عن خبراتك..." />
                                </div>
                            </div>
                        </div>

                        <!-- Social Metadata -->
                        <div class="glass-card p-4 mb-4 shadow-sm animate-up" style="animation-delay: 0.3s;">
                            <h5 class="fw-bold mb-4 border-bottom pb-2 text-primary">حسابات التواصل</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-globe text-primary"></i></span>
                                        <InputText @bind-Value="model.WebsiteUrl" class="form-control premium-input border-start-0" placeholder="الموقع الإلكتروني" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="fa-brands fa-facebook text-info"></i></span>
                                        <InputText @bind-Value="model.FacebookUrl" class="form-control premium-input border-start-0" placeholder="رابط الفيسبوك" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="fa-brands fa-instagram text-danger"></i></span>
                                        <InputText @bind-Value="model.InstagramUrl" class="form-control premium-input border-start-0" placeholder="اسم المستخدم (الانستجرام)" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="fa-brands fa-whatsapp text-success"></i></span>
                                        <InputText @bind-Value="model.TwitterUrl" class="form-control premium-input border-start-0" placeholder="اسم المستخدم (Y/Twitter)" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div class="d-flex justify-content-end mb-5 animate-up">
                            <button type="submit" class="btn btn-primary-premium px-5 py-3 rounded-pill shadow-lg" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>جاري الحفظ...</span>
                                }
                                else
                                {
                                    <i class="fa-solid fa-save me-2"></i><span>حفظ كافة التغييرات</span>
                                }
                            </button>
                        </div>
                    </EditForm>

                    <!-- User Services Area (View Only) -->
                    <div class="glass-card p-4 shadow-sm animate-up">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold mb-0">خدماتي المنشورة</h5>
                            <button class="btn btn-sm btn-outline-primary rounded-pill px-3" @onclick='() => Navigation.NavigateTo("/provider/createservice")'>
                                <i class="fa-solid fa-plus me-1"></i>خدمة جديدة
                            </button>
                        </div>
                        
                        @if (userServices.Any())
                        {
                            <div class="row g-3">
                                @foreach (var s in userServices)
                                {
                                    <div class="col-md-6">
                                        <div class="service-item-compact p-3 rounded-4 border bg-white cursor-pointer" @onclick='() => Navigation.NavigateTo($"/service/{s.Id}")'>
                                            <div class="d-flex align-items-center">
                                                <img src="@Khadamat.BlazorUI.Helpers.DefaultImages.GetServiceImage(s.CategoryName, s.Images?.FirstOrDefault())" class="rounded-3 me-3" width="60" height="60" style="object-fit: cover;" />
                                                <div class="flex-grow-1 min-w-0">
                                                    <h6 class="fw-bold mb-1 text-truncate">@s.Title</h6>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="x-small text-muted">@s.CategoryName</span>
                                                        <span class="fw-bold text-primary small">@s.Price?.ToString("N0") ج.م</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4 text-muted border border-dashed rounded-4">
                                <i class="fa-solid fa-box-open fs-2 mb-2 d-block"></i>
                                <p class="small mb-0">لا توجد خدمات مضافة حتى الآن</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .profile-premium-page { background: #f8fafc; min-height: 100vh; }
    
    .profile-hero {
        position: relative;
        height: 250px;
        border-radius: 24px;
        overflow: hidden;
        background: #1e293b;
    }
    
    .hero-cover {
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
        opacity: 0.9;
    }
    
    .hero-content {
        position: relative;
        height: 100%;
        z-index: 10;
    }
    
    .avatar-large-wrapper {
        position: relative;
        margin-bottom: -10px;
    }
    
    .avatar-large {
        width: 140px;
        height: 140px;
        border-radius: 32px;
        border: 4px solid white;
        object-fit: cover;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .avatar-edit-badge {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        color: var(--theme-primary);
        font-size: 0.9rem;
    }
    
    .premium-input {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        background: #fdfdfd;
        transition: all 0.2s;
    }
    
    .premium-input:focus {
        border-color: var(--theme-primary);
        box-shadow: 0 0 0 4px var(--theme-glow);
    }
    
    .service-item-compact {
        transition: all 0.3s;
    }
    .service-item-compact:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.05);
        border-color: var(--theme-primary) !important;
    }
    
    [dir="rtl"] .hero-text-area { padding-right: 20px; }
    
    .bg-light-success { background: #dcfce7; }
    .bg-light-danger { background: #fee2e2; }
    .bg-light-primary { background: #e0e7ff; }

    .animate-up { animation: fadeInUp 0.5s calc(var(--delay, 0s)) both; }
    @@keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @@keyframes popIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
</style>

@code {
    private AuthResponse? profile;
    private UpdateProfileRequest model = new();
    private List<ServiceDto> userServices = new();
    private List<GovernorateDto> governorates = new();
    private List<CityDto> cities = new();
    private int selectedGovernorateId;
    
    private bool isLoading = true;
    private bool isSaving = false;
    private string feedbackMessage = "";
    private bool isSuccess = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var profileResult = await AuthService.GetProfileAsync();
            if (profileResult?.Success == true && profileResult.Data != null)
            {
                profile = profileResult.Data;
                
                // Map to model
                model.FullName = profile.FullName;
                model.PhoneNumber = profile.PhoneNumber ?? "";
                model.CityId = profile.CityId ?? 0;
                model.ProfileImageUrl = profile.ImageUrl;
                model.Bio = profile.Bio;
                model.WebsiteUrl = profile.WebsiteUrl;
                model.FacebookUrl = profile.FacebookUrl;
                model.InstagramUrl = profile.InstagramUrl;
                model.TwitterUrl = profile.TwitterUrl;
                
                selectedGovernorateId = profile.GovernorateId ?? 0;

                // Load support data
                var govTask = Api.GetGovernoratesAsync();
                var serviceTask = Api.GetMyServicesAsync();
                await Task.WhenAll(govTask, serviceTask);
                
                governorates = govTask.Result;
                userServices = serviceTask.Result.Items;
                
                if (selectedGovernorateId > 0)
                {
                    cities = await Api.GetCitiesAsync(selectedGovernorateId);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            feedbackMessage = "حدث خطأ أثناء تحميل البيانات";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnGovernorateChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val))
        {
            selectedGovernorateId = val;
            cities = await Api.GetCitiesAsync(val);
            model.CityId = 0;
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.GetMultipleFiles(1).FirstOrDefault();
        if (file != null)
        {
            var format = "image/jpeg";
            var resizedImage = await file.RequestImageFileAsync(format, 400, 400);
            var buffer = new byte[resizedImage.Size];
            await resizedImage.OpenReadStream().ReadAsync(buffer);
            model.ProfileImageUrl = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        }
    }

    private async Task HandleProfileSave()
    {
        isSaving = true;
        feedbackMessage = "";
        try
        {
            var result = await AuthService.UpdateProfile(model);
            if (result.Success)
            {
                isSuccess = true;
                feedbackMessage = "تم حفظ التعديلات بنجاح";
                
                // Sync State
                AppState.UserName = model.FullName;
                AppState.PhoneNumber = model.PhoneNumber;
                if (!string.IsNullOrEmpty(model.ProfileImageUrl)) AppState.UserImageUrl = model.ProfileImageUrl;

                // Refresh actual profile data
                 _ = AuthService.GetProfileAsync();
            }
            else
            {
                isSuccess = false;
                feedbackMessage = result.Message ?? "فشل تحديث البيانات، يرجى التأكد من الحقول";
            }
        }
        catch (Exception ex)
        {
            isSuccess = false;
            feedbackMessage = "حدث خطأ تقني غير متوقع";
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isSaving = false;
        }
    }
}

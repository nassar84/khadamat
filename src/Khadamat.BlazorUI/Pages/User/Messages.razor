@page "/user/messages"
@page "/user/messages/{OtherUserId}"
@attribute [Authorize]
@inject ApiClient Api
@inject SignalRClientService SignalRService
@inject NavigationManager Navigation
@inject AppState State
@inject IJSRuntime JS
@implements IDisposable

<div class="messages-container glass-card overflow-hidden m-0 m-md-3">
    <div class="row g-0 h-100">
        <!-- Sidebar: Conversations List -->
        <div class="col-12 col-md-4 col-lg-3 conversation-sidebar @(string.IsNullOrEmpty(OtherUserId) ? "" : "d-none d-md-block")">
            <div class="p-3 border-bottom bg-light d-flex align-items-center justify-content-between">
                <h5 class="mb-0 fw-bold">المحادثات</h5>
                <button class="btn btn-sm btn-outline-primary rounded-circle"><i class="fas fa-edit"></i></button>
            </div>
            <div class="conversation-list overflow-auto">
                @if (conversations == null)
                {
                    <div class="p-4 text-center">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </div>
                }
                else if (!conversations.Any())
                {
                    <div class="p-4 text-center text-muted">
                        <i class="far fa-comments fs-1 mb-3 opacity-25"></i>
                        <p>لا توجد محادثات بعد</p>
                    </div>
                }
                else
                {
                    @foreach (var conv in conversations)
                    {
                        <div class="conversation-item p-3 d-flex align-items-center cursor-pointer @(OtherUserId == conv.OtherPartyId ? "active" : "") @(conv.UnreadCount > 0 ? "unread" : "")"
                             @onclick="() => SelectConversation(conv.OtherPartyId)">
                            <div class="avatar-wrapper me-3">
                                <img src="@(string.IsNullOrEmpty(conv.OtherPartyPhoto) ? "/img/default-avatar.png" : conv.OtherPartyPhoto)" class="avatar rounded-circle" alt="@conv.OtherPartyName" />
                                @if (conv.UnreadCount > 0)
                                {
                                    <span class="unread-badge">@conv.UnreadCount</span>
                                }
                            </div>
                            <div class="flex-grow-1 min-width-0">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h6 class="mb-0 text-truncate fw-bold">@conv.OtherPartyName</h6>
                                    <span class="smaller text-muted">@FormatDate(conv.LastMessageTime)</span>
                                </div>
                                <p class="mb-0 text-truncate smaller @(conv.UnreadCount > 0 ? "text-dark" : "text-muted")">@conv.LastMessage</p>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Main: Chat Area -->
        <div class="col-12 col-md-8 col-lg-9 chat-area d-flex flex-column @(string.IsNullOrEmpty(OtherUserId) ? "d-none d-md-flex justify-content-center align-items-center bg-light" : "")">
            @if (string.IsNullOrEmpty(OtherUserId))
            {
                <div class="text-center p-5">
                    <div class="welcome-chat-icon mb-4">
                        <i class="fas fa-comments text-primary display-1 opacity-25"></i>
                    </div>
                    <h3 class="fw-bold">اهلا بك في الرسائل</h3>
                    <p class="text-muted">اختر محادثة من القائمة للبدء أو تصفح الخدمات للتواصل مع المزودين</p>
                    <button class="btn btn-primary-premium rounded-pill px-4 mt-3" @onclick='() => Navigation.NavigateTo("/services")'>تصفح الخدمات</button>
                </div>
            }
            else
            {
                <!-- Chat Header -->
                <div class="chat-header p-3 border-bottom bg-white d-flex align-items-center">
                    <button class="btn btn-link link-dark d-md-none me-2" @onclick="GoBackToConversations">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <div class="d-flex align-items-center">
                        <img src="@(currentOtherPartyPhoto ?? "/img/default-avatar.png")" class="avatar-sm rounded-circle me-3" />
                        <div>
                            <h6 class="mb-0 fw-bold">@currentOtherPartyName</h6>
                            <span class="smaller text-success"><i class="fas fa-circle me-1"></i> متصل الآن</span>
                        </div>
                    </div>
                    <div class="ms-auto">
                        <button class="btn btn-icon-light"><i class="fas fa-phone"></i></button>
                        <button class="btn btn-icon-light"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                </div>

                <!-- Messages area -->
                <div class="chat-messages p-3 flex-grow-1 overflow-auto bg-light-soft" id="chatMessages">
                    @if (messages == null)
                    {
                        <div class="h-100 d-flex justify-content-center align-items-center">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    }
                    else
                    {
                        DateTime? lastDate = null;
                        @foreach (var msg in messages)
                        {
                            bool isMe = msg.SenderId == State.UserToken; // Needs proper comparison, maybe decode token or use State.UserName
                            // For now, assume MessageDto has IsMine property calculated by API or we do it here
                            // Let's use simplified logic:
                            bool mine = msg.SenderId != OtherUserId;

                            if (lastDate == null || lastDate.Value.Date != msg.CreatedAt.Date)
                            {
                                <div class="date-divider my-4 text-center px-3">
                                    <span class="bg-white px-3 py-1 rounded-pill smaller shadow-sm border">@msg.CreatedAt.ToString("D")</span>
                                </div>
                                lastDate = msg.CreatedAt;
                            }

                            <div class="message-wrapper mb-3 @(mine ? "mine" : "theirs")">
                                <div class="message-content p-3 shadow-sm">
                                    <p class="mb-1">@msg.Content</p>
                                    <div class="text-end smaller opacity-50 message-time">
                                        @msg.CreatedAt.ToString("t")
                                        @if (mine)
                                        {
                                            <i class="fas fa-check-double ms-1 @(msg.IsRead ? "text-primary" : "")"></i>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Input area -->
                <div class="chat-input-area p-3 bg-white border-top">
                    <div class="input-group">
                        <button class="btn btn-light-premium rounded-circle me-2"><i class="fas fa-paperclip"></i></button>
                        <input type="text" class="form-control premium-input br-50" 
                               placeholder="اكتب رسالتك هنا..." 
                               @bind="newMessage" 
                               @onkeyup="HandleKeyPress" />
                        <button class="btn btn-primary-premium rounded-circle ms-2 send-btn" 
                                @onclick="SendMessage" 
                                disabled="@(string.IsNullOrWhiteSpace(newMessage))">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .messages-container {
        height: calc(100vh - 120px);
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    .conversation-sidebar {
        border-left: 1px solid #eee;
        display: flex;
        flex-direction: column;
    }

    .conversation-list {
        flex-grow: 1;
    }

    .conversation-item {
        transition: all 0.2s ease;
        border-bottom: 1px solid #f8f9fa;
    }

    .conversation-item:hover {
        background-color: #f0f4ff;
    }

    .conversation-item.active {
        background-color: #eef2ff;
        border-right: 4px solid var(--primary-color, #6366f1);
    }

    .conversation-item.unread {
        background-color: #fff;
    }

    .avatar-wrapper {
        position: relative;
    }

    .avatar {
        width: 48px;
        height: 48px;
        object-fit: cover;
    }

    .avatar-sm {
        width: 40px;
        height: 40px;
        object-fit: cover;
    }

    .unread-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ef4444;
        color: white;
        font-size: 10px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
    }

    .chat-messages {
        background: #f8fafc;
        display: flex;
        flex-direction: column;
    }

    .message-wrapper {
        display: flex;
        width: 100%;
        margin-bottom: 0.5rem;
    }

    .message-wrapper.mine {
        justify-content: flex-end;
    }

    .message-wrapper.theirs {
        justify-content: flex-start;
    }

    .message-content {
        max-width: 75%;
        border-radius: 1.2rem;
        position: relative;
    }

    .mine .message-content {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        border-bottom-right-radius: 0.2rem;
    }

    .theirs .message-content {
        background: white;
        color: #1e293b;
        border-bottom-left-radius: 0.2rem;
    }

    .message-time {
        font-size: 10px;
        margin-top: 4px;
    }

    .br-50 {
        border-radius: 25px !important;
    }

    .chat-input-area .send-btn {
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .bg-light-soft {
        background-color: #f1f5f9;
        background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
        background-size: 20px 20px;
    }

    .smaller {
        font-size: 0.75rem;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    @@media (max-width: 767.98px) {
        .messages-container {
            height: calc(100vh - 140px);
            margin: 0;
            border-radius: 0;
        }
    }
</style>

@code {
    [Parameter] public string? OtherUserId { get; set; }

    private List<ConversationDto>? conversations;
    private List<MessageDto>? messages;
    private string newMessage = "";
    private string? currentOtherPartyName;
    private string? currentOtherPartyPhoto;

    protected override async Task OnInitializedAsync()
    {
        SignalRService.MessageReceived += HandleMessageReceived;
        await LoadConversations();

        if (!string.IsNullOrEmpty(OtherUserId))
        {
            await LoadMessages(OtherUserId);
        }
    }

    private async Task LoadConversations()
    {
        conversations = await Api.GetConversationsAsync();
        StateHasChanged();
    }

    private async Task LoadMessages(string userId)
    {
        messages = await Api.GetMessagesAsync(userId);
        var conv = conversations?.FirstOrDefault(c => c.OtherPartyId == userId);
        if (conv != null)
        {
            currentOtherPartyName = conv.OtherPartyName;
            currentOtherPartyPhoto = conv.OtherPartyPhoto;
        }
        else 
        {
             // If navigating from service page, details might not be in conversations yet
             // Need a way to fetch user info if not in list
             currentOtherPartyName = "المزود";
        }
        
        StateHasChanged();
        await ScrollToBottom();
    }

    private async Task SelectConversation(string userId)
    {
        if (OtherUserId == userId) return;
        OtherUserId = userId;
        Navigation.NavigateTo($"/user/messages/{userId}", false);
        await LoadMessages(userId);
    }

    private void GoBackToConversations()
    {
        OtherUserId = null;
        Navigation.NavigateTo("/user/messages", false);
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || string.IsNullOrEmpty(OtherUserId)) return;

        var content = newMessage;
        newMessage = "";

        var success = await Api.SendMessageAsync(OtherUserId, content);
        if (success)
        {
            // Add to UI immediately
            var msg = new MessageDto
            {
                SenderId = State.UserToken ?? "", // Use actual ID from token
                ReceiverId = OtherUserId,
                Content = content,
                CreatedAt = DateTime.UtcNow,
                IsRead = false
            };
            
            messages?.Add(msg);
            
            // Update conversation list item or move to top
            await LoadConversations();
            
            await ScrollToBottom();
        }
    }

    private void HandleMessageReceived(MessageDto message)
    {
        InvokeAsync(async () => {
            // If the message is from the currently active chat
            if (message.SenderId == OtherUserId)
            {
                messages?.Add(message);
                await ScrollToBottom();
            }
            
            await LoadConversations();
            StateHasChanged();
        });
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    private string FormatDate(DateTime dt)
    {
        if (dt.Date == DateTime.Today) return dt.ToString("t");
        if (dt.Date == DateTime.Today.AddDays(-1)) return "أمس";
        if ((DateTime.Today - dt.Date).TotalDays < 7) return dt.ToString("dddd");
        return dt.ToString("d");
    }

    private async Task ScrollToBottom()
    {
        try 
        {
            await JS.InvokeVoidAsync("scrollToBottom", "chatMessages");
        }
        catch { }
    }

    public void Dispose()
    {
        SignalRService.MessageReceived -= HandleMessageReceived;
    }
}

@page "/provider/create-request"
@layout Khadamat.BlazorUI.Layout.MainLayout
@using Khadamat.Application.DTOs
@using Khadamat.Application.Features.Services.Commands
@using Khadamat.BlazorUI.Services
@using Khadamat.BlazorUI.Services.Auth
@inject ApiClient Api
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject Khadamat.BlazorUI.State.AppState AppState

<div class="request-page pb-5">
    <div class="header-banner text-white py-5 text-center mb-0" style="background: linear-gradient(135deg, #1e3a8a, #3b82f6);">
        <div class="container animate-fade-in">
            <i class="fa-solid fa-paper-plane fs-1 mb-3 floating"></i>
            <h1 class="fw-bold h2">إضافة نشاط تجاري</h1>
            <p class="opacity-75">ساعدنا في إثراء منصة عراري عبر تزويدنا بالبيانات الصحيحة، فريقنا سيقوم بمراجعة الطلب</p>
        </div>
    </div>

    <div class="container mt-n5 position-relative z-2">
        @if (showSuccess)
        {
            <div class="glass-card p-5 text-center animate-up border-0 rounded-4 shadow-2xl">
                <div class="success-icon-wrapper mb-4">
                    <i class="fa-solid fa-circle-check text-success display-1"></i>
                </div>
                <h2 class="fw-bold mb-3">تم إرسال طلبك بنجاح!</h2>
                <p class="text-muted mb-4">فريقنا سيقوم بمراجعة البيانات قريباً. يمكنك متابعة حالة الخدمة من لوحة التحكم الخاصة بك.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-primary-premium rounded-pill px-5 py-2" @onclick='() => Navigation.NavigateTo("/provider/myservices")'>مشاهدة خدماتي</button>
                    <button class="btn btn-light rounded-pill px-5 py-2" @onclick="() => showSuccess = false">إضافة خدمة أخرى</button>
                </div>
            </div>
        }
        else
        {
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger rounded-4 mb-4 animate-fade-in d-flex align-items-center">
                    <i class="fa-solid fa-triangle-exclamation me-3 fs-4"></i>
                    <div>
                        <div class="fw-bold">حدث خطأ أثناء إرسال الطلب:</div>
                        <div>@errorMessage</div>
                    </div>
                </div>
            }

            <div class="form-container glass-card p-0 overflow-hidden shadow-2xl border-0 rounded-4 animate-up">
                <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />

                    <!-- Step 1: Basic Info -->
                    <div class="form-section p-4 p-md-5">
                        <div class="d-flex align-items-center mb-4">
                            <div class="step-badge me-3">1</div>
                            <h4 class="fw-bold mb-0">البيانات الأساسية <span class="text-danger">*</span></h4>
                        </div>

                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label fw-bold small">اسم النشاط (المحل، العيادة، الشركة...)</label>
                                <InputText @bind-Value="model.Title" class="form-control premium-input" placeholder="مثال: مطعم النيل للمأكولات البحرية" />
                                <ValidationMessage For="@(() => model.Title)" class="text-danger small mt-1" />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold small">التصنيف الرئيسي</label>
                                <select class="form-select premium-input" @onchange="OnMainCategoryChanged">
                                    <option value="">اختر التصنيف...</option>
                                    @foreach (var mc in mainCategories)
                                    {
                                        <option value="@mc.Id" selected="@(selectedMainCategoryId == mc.Id)">@mc.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">القسم</label>
                                <select class="form-select premium-input" @onchange="OnCategoryChanged">
                                    <option value="">اختر القسم...</option>
                                    @foreach (var c in categories)
                                    {
                                        <option value="@c.Id" selected="@(selectedCategoryId == c.Id)">@c.Name</option>
                                    }
                                </select>
                                <ValidationMessage For="@(() => model.CategoryId)" class="text-danger small mt-1" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">القسم الفرعي</label>
                                <InputSelect @bind-Value="model.SubCategoryId" class="form-select premium-input">
                                    <option value="">اختر القسم الفرعي...</option>
                                    @foreach (var sc in subCategories)
                                    {
                                        <option value="@sc.Id">@sc.Name</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">المحافظة</label>
                                <select class="form-select premium-input" @onchange="OnGovernorateChanged" value="@selectedGovernorateId">
                                    <option value="">اختر المحافظة...</option>
                                    @foreach (var gov in governorates)
                                    {
                                        <option value="@gov.Id">@gov.NameAr</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">المدينة</label>
                                <InputSelect @bind-Value="model.CityId" class="form-select premium-input">
                                    <option value="">اختر المدينة...</option>
                                    @foreach (var city in cities)
                                    {
                                        <option value="@city.Id">@city.NameAr</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => model.CityId)" class="text-danger small mt-1" />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold small">العنوان بالتفصيل</label>
                                <InputText @bind-Value="model.Address" class="form-control premium-input" placeholder="مثال: شارع الجلاء، بجوار بنك مصر" />
                                <ValidationMessage For="@(() => model.Address)" class="text-danger small mt-1" />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold small">وصف النشاط والخدمات</label>
                                <InputTextArea @bind-Value="model.Description" class="form-control premium-input" rows="4" placeholder="قدم وصفاً جذاباً للنشاط ومميزاته..." />
                                <ValidationMessage For="@(() => model.Description)" class="text-danger small mt-1" />
                            </div>
                        </div>
                    </div>

                    <hr class="m-0 opacity-10">

                    <!-- Step 2: Media & Contact -->
                    <div class="form-section p-4 p-md-5 bg-light-soft">
                        <div class="d-flex align-items-center mb-4">
                            <div class="step-badge me-3">2</div>
                            <h4 class="fw-bold mb-0">بيانات التواصل والوسائط</h4>
                        </div>

                        <div class="image-upload-wrapper mb-4 text-center p-5 border-dashed rounded-4 bg-white position-relative overflow-hidden">
                            <div class="upload-icon mb-3">
                                <i class="fa-solid fa-cloud-arrow-up fs-1 text-blue-500 floating"></i>
                            </div>
                            <h6 class="fw-bold">صورة النشاط الأساسية</h6>
                            <p class="text-muted small">يفضل أن تكون الصورة ذات جودة عالية وواضحة (JPG, PNG)</p>
                            
                            <div class="mt-3">
                                 @if (string.IsNullOrEmpty(mainImageUrl))
                                 {
                                     <label class="btn btn-primary-premium rounded-pill px-4 py-2 cursor-pointer shadow-sm">
                                         <span>اختيار صورة</span>
                                         <InputFile OnChange="HandleFileSelected" class="d-none" accept=".jpg,.jpeg,.png" />
                                     </label>
                                     <p class="mt-2 text-muted small">لم يتم اختيار أي ملف</p>
                                 }
                                 else
                                 {
                                     <div class="position-relative d-inline-block">
                                         <img src="@mainImageUrl" class="rounded-3 shadow-lg border animate-scale-in" style="max-height: 200px; max-width: 100%; border: 4px solid white !important;" />
                                         <button type="button" class="btn btn-danger btn-sm rounded-circle position-absolute top-0 end-0 m-n2 shadow-lg scale-hover" @onclick="() => mainImageUrl = null">
                                             <i class="fas fa-times"></i>
                                         </button>
                                     </div>
                                 }
                            </div>
                            @if (isUploading)
                            {
                                <div class="upload-overlay position-absolute inset-0 bg-white bg-opacity-75 d-flex align-items-center justify-content-center">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </div>
                            }
                        </div>

                        <div class="row g-4">
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">رقم الهاتف 1</label>
                                <InputText @bind-Value="model.Phone1" class="form-control premium-input text-start" dir="ltr" placeholder="01xxxxxxxxx" />
                                <ValidationMessage For="@(() => model.Phone1)" class="text-danger small mt-1" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">رقم الهاتف 2</label>
                                <InputText @bind-Value="model.Phone2" class="form-control premium-input text-start" dir="ltr" placeholder="رقم إضافي" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">رقم واتساب</label>
                                <InputText @bind-Value="model.WhatsApp" class="form-control premium-input text-start" dir="ltr" placeholder="رقم مخصص للواتساب" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">رابط فيسبوك</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0 text-primary"><i class="fab fa-facebook"></i></span>
                                    <InputText @bind-Value="model.Facebook" class="form-control border-start-0 premium-input text-start" dir="ltr" placeholder="facebook.com/user" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">رابط تيليجرام</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0 text-info"><i class="fab fa-telegram"></i></span>
                                    <InputText @bind-Value="model.Telegram" class="form-control border-start-0 premium-input text-start" dir="ltr" placeholder="t.me/user" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">أيام العمل</label>
                                <InputText @bind-Value="model.WorkDays" class="form-control premium-input" placeholder="مثال: الأحد - الخميس" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">ساعات العمل</label>
                                <InputText @bind-Value="model.WorkHours" class="form-control premium-input" placeholder="مثال: 9 ص - 10 م" />
                            </div>
                        </div>
                    </div>

                    <hr class="m-0 opacity-10">

                    <!-- Step 3: Requester Info -->
                    <div class="form-section p-4 p-md-5">
                        <div class="d-flex align-items-center mb-4">
                            <div class="step-badge me-3">3</div>
                            <h4 class="fw-bold mb-0">بيانات مقدم الطلب</h4>
                        </div>

                        <div class="row g-4">
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">اسمك الكريم</label>
                                <div class="p-3 bg-light rounded-3 text-muted border border-dashed">@currentProfile?.UserName</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">البريد الإلكتروني</label>
                                <div class="p-3 bg-light rounded-3 text-muted border border-dashed">@currentProfile?.Email</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold small">رقم التواصل</label>
                                <div class="p-3 bg-light rounded-3 text-muted border border-dashed">@currentProfile?.PhoneNumber</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 p-md-5 pt-0 text-center">
                        <button type="submit" class="btn btn-primary-gradient px-5 py-3 rounded-pill shadow-lg w-100 mb-3 floating-btn-hover" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>جاري إرسال الطلب...</span>
                            }
                            else
                            {
                                <i class="fa-solid fa-check-circle me-2 scale-hover"></i>
                                <span>إرسال الطلب للمراجعة</span>
                            }
                        </button>
                        <p class="text-muted small">بإرسالك لهذا الطلب، أنت توافق على شروط سياسة الخصوصية الخاصة بمنصة عراري</p>
                    </div>
                </EditForm>
            </div>
        }

        <div class="text-center mt-4 mb-5 pb-5">
            <h6 class="text-muted">هل تواجه مشكلة في ملء النموذج؟</h6>
            <a href="https://wa.me/201234567890" class="btn btn-outline-success rounded-pill px-5 py-3 mt-2 shadow-premium scale-hover transition-all">
                <i class="fab fa-whatsapp me-2 fs-5"></i> تواصل معنا مباشرة عبر واتساب
            </a>
        </div>
    </div>
</div>

<style>
    .request-page {
        background-color: #f8fafc;
        min-height: 100vh;
    }

    /* Success Icon Animation */
    .success-icon-wrapper i {
        animation: successPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @@keyframes successPop {
        0% { transform: scale(0); }
        80% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    /* Hide Footer from layout on this page specifically */
    footer, .footer-container {
        display: none !important;
    }

    .mt-n5 {
        margin-top: -3.5rem !important;
    }

    .step-badge {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
    }

    .border-dashed {
        border: 2px dashed #e2e8f0 !important;
        transition: all 0.3s;
    }

    .border-dashed:hover {
        border-color: #3b82f6 !important;
        background-color: #f1f5f9 !important;
    }

    .bg-light-soft {
        background-color: #f8fafc;
    }

    .premium-input {
        padding: 0.85rem 1.25rem;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        background-color: #fff;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.95rem;
    }

    .premium-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
    }

    .btn-primary-gradient {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        border: none;
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary-gradient:hover:not(:disabled) {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4) !important;
    }

    .floating-btn-hover:hover .fa-solid {
        transform: rotate(360deg);
        transition: transform 0.6s ease;
    }

    .shadow-premium {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .shadow-2xl {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
    }

    .animate-up {
        animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @@keyframes slideUp {
        from { opacity: 0; transform: translateY(40px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .floating {
        animation: floatingAnim 3s ease-in-out infinite;
    }

    @@keyframes floatingAnim {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .scale-hover {
        transition: transform 0.3s ease;
    }

    .scale-hover:hover {
        transform: scale(1.1);
    }

    .inset-0 { top: 0; left: 0; right: 0; bottom: 0; }
    .cursor-pointer { cursor: pointer; }
    
    .animate-fade-in { animation: fadeIn 0.8s ease-out; }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .animate-scale-in { animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    @@keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>

@code {
    private CreateServiceCommand model = new();
    private bool isSaving = false;
    private bool isUploading = false;
    private string? mainImageUrl;
    private AuthResponse? currentProfile;
    private bool showSuccess = false;
    private string? errorMessage;

    private List<MainCategoryDto> mainCategories = new();
    private List<CategoryDto> categories = new();
    private List<SubCategoryDto> subCategories = new();
    
    private List<GovernorateDto> governorates = new();
    private List<CityDto> cities = new();

    private int selectedMainCategoryId;
    private int selectedCategoryId;
    private int selectedGovernorateId;

    protected override async Task OnInitializedAsync()
    {
        // Enforce profile completeness
        if (!AppState.IsProfileComplete)
        {
            Navigation.NavigateTo("/settings?returnUrl=/provider/create-request");
            return;
        }

        try 
        {
            // Load initial lookup data
            mainCategories = await Api.GetMainCategoriesAsync();
            governorates = await Api.GetGovernoratesAsync();
            
            // Set current user data by default
            var profileResult = await AuthService.GetProfileAsync();
            if (profileResult?.Success == true)
            {
                currentProfile = profileResult.Data;
                if (currentProfile != null)
                {
                    // Pre-fill model with user profile data
                    model.Phone1 = currentProfile.PhoneNumber;
                    model.CityId = currentProfile.CityId;
                    
                    // Pre-select governorate based on city
                    if (currentProfile.GovernorateId.HasValue)
                    {
                        selectedGovernorateId = currentProfile.GovernorateId.Value;
                        cities = await Api.GetCitiesAsync(selectedGovernorateId);
                        StateHasChanged();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading initial data: {ex.Message}");
        }
    }

    private async Task OnMainCategoryChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val))
        {
            selectedMainCategoryId = val;
            categories = await Api.GetCategoriesByMainIdAsync(selectedMainCategoryId);
            selectedCategoryId = 0;
            subCategories.Clear();
            model.CategoryId = null;
            model.SubCategoryId = null;
        }
    }

    private async Task OnCategoryChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val))
        {
            selectedCategoryId = val;
            model.CategoryId = val;
            subCategories = await Api.GetSubCategoriesByCategoryIdAsync(selectedCategoryId);
            model.SubCategoryId = null;
        }
        else
        {
            selectedCategoryId = 0;
            model.CategoryId = null;
            subCategories.Clear();
        }
    }

    private async Task OnGovernorateChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val))
        {
            selectedGovernorateId = val;
            cities = await Api.GetCitiesAsync(selectedGovernorateId);
            model.CityId = 0;
        }
        else
        {
            selectedGovernorateId = 0;
            cities.Clear();
            model.CityId = 0;
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            isUploading = true;
            try 
            {
                var format = "image/png";
                var resizedFile = await file.RequestImageFileAsync(format, 800, 600);
                var buffer = new byte[resizedFile.Size];
                using var stream = resizedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                await stream.ReadAsync(buffer);
                mainImageUrl = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
            }
            catch (Exception ex)
            {
                Console.WriteLine("Upload error: " + ex.Message);
                await JS.InvokeVoidAsync("alert", "حدث خطأ أثناء معالجة الصورة. يرجى التأكد من أن حجمها مناسب.");
            }
            finally
            {
                isUploading = false;
            }
        }
    }

    private async Task HandleSubmit()
    {
        errorMessage = null;

        // Additional manual validation for cascading dropdowns
        if (selectedMainCategoryId == 0 || selectedCategoryId == 0)
        {
            errorMessage = "يرجى اختيار التصنيف الرئيسي والقسم";
            return;
        }

        if (model.CityId == 0 || model.CityId == null)
        {
            errorMessage = "يرجى اختيار المدينة";
            return;
        }

        isSaving = true;
        try
        {
            // Attach images to model
            if (!string.IsNullOrEmpty(mainImageUrl))
            {
                model.Images = new List<string> { mainImageUrl };
            }

            var result = await Api.CreateServiceAsync(model);
            if (result.HasValue)
            {
                // Refresh profile to update IsProvider status in AppState
                await AuthService.GetProfileAsync();
                
                showSuccess = true;
                StateHasChanged();
            }
            else 
            {
                errorMessage = "فشل في إرسال الطلب، يرجى مراجعة البيانات المدخلة أو المحاولة لاحقاً.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Submit error: " + ex);
            errorMessage = "حدث خطأ غير متوقع: " + ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }
}

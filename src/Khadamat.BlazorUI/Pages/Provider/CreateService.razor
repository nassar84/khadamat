@page "/provider/createservice"
@page "/provider/editservice/{Id:int}"
@using Khadamat.Application.DTOs
@using Khadamat.Application.Features.Services.Commands
@using Khadamat.BlazorUI.Services
@using Khadamat.BlazorUI.Shared.Components
@inject ApiClient Api
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="px-3 pt-3 pb-5">
    <div class="mb-4">
         <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/provider/providerdashboard" class="text-decoration-none text-muted">لوحة المزود</a></li>
                <li class="breadcrumb-item active">@(Id == 0 ? "إضافة خدمة جديدة" : "تعديل الخدمة")</li>
            </ol>
        </nav>
        <h3 class="fw-bold mb-0 text-primary">@(Id == 0 ? "إضافة خدمة جديدة" : $"تعديل: {serviceTitle}")</h3>
    </div>

    @if (isDemoMode)
    {
        <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
             <i class="fa-solid fa-triangle-exclamation me-2"></i>
             <div>
                 <strong>وضع العرض التجريبي:</strong> فشل تحميل التصنيفات والمواقع من الخادم، يتم استخدام بيانات وهمية للتجربة.
             </div>
        </div>
    }

    @if(isLoadingData)
    {
         <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">جاري تحميل البيانات...</p>
        </div>
    }
    else
    {
        <ServiceForm Model="@model" 
                     MainCategories="@mainCategories" 
                     Governorates="@governorates"
                     IsSaving="@isSaving"
                     ShowTitle="false"
                     Id="@Id"
                     OnSave="SaveChanges"
                     OnCancel="GoBack" /> 
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    
    private ServiceForm.ServiceFormModel model = new();
    private string? serviceTitle;
    private bool isSaving = false;
    private bool isLoadingData = true;

    private List<MainCategoryDto> mainCategories = new();
    private List<GovernorateDto> governorates = new();

    private bool isDemoMode = false;

    protected override async Task OnInitializedAsync()
    {
        isLoadingData = true;
        isDemoMode = false;
        try 
        {
            var categoriesTask = Api.GetMainCategoriesAsync();
            var governoratesTask = Api.GetGovernoratesAsync();

            await Task.WhenAll(categoriesTask, governoratesTask);
            
            mainCategories = categoriesTask.Result;
            governorates = governoratesTask.Result;
            
            // If API returns empty lists (due to logic handled inside ApiClient returning new List on error),
            // check if we really have data. If empty, switch to demo mode.
            if (!mainCategories.Any() || !governorates.Any())
            {
                throw new Exception("Empty data loaded");
            }
    
            if (Id != 0)
            {
                var service = await Api.GetServiceByIdAsync(Id);
                if (service != null)
                {
                    serviceTitle = service.Title;
                    // ... (mapping logic remains same, abstracted for brevity in tool call if possible, but here I must be precise)
                    model = new ServiceForm.ServiceFormModel
                    {
                        Title = service.Title,
                        Description = service.Description,
                        Price = service.Price,
                        Address = service.Address,
                        CityId = service.CityId,
                        Location = service.Location,
                        CategoryId = service.CategoryId,
                        SubCategoryId = service.SubCategoryId,
                        Phone1 = service.Phone1,
                        WhatsApp = service.WhatsApp,
                        Facebook = service.Facebook,
                        Telegram = service.Telegram,
                        WorkDays = service.WorkDays,
                        WorkHours = service.WorkHours,
                        YouTubeUrl = service.YouTubeUrl,
                        Images = service.Images ?? new List<string>()
                    };
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading create service data: {ex.Message}");
            isDemoMode = true;
            LoadMockData();
        }
        finally
        {
            isLoadingData = false;
        }
    }

    private void LoadMockData()
    {
        // Mock Categories
        mainCategories = new List<MainCategoryDto>
        {
            new MainCategoryDto { Id = 1, Name = "خدمات منزلية" },
            new MainCategoryDto { Id = 2, Name = "خدمات تقنية" },
            new MainCategoryDto { Id = 3, Name = "دروس خصوصية" },
            new MainCategoryDto { Id = 4, Name = "صيانة سيارات" }
        };

        // Mock Governorates
        governorates = new List<GovernorateDto>
        {
            new GovernorateDto { Id = 1, NameAr = "الرياض" },
            new GovernorateDto { Id = 2, NameAr = "مكة المكرمة" },
            new GovernorateDto { Id = 3, NameAr = "الشرقية" }
        };
    }

    private void SimulateUpload()
    {
        // Mock image upload
        var randomImg = $"https://picsum.photos/800/600?random={Random.Shared.Next(100)}";
        model.Images.Insert(0, randomImg);
        // Force update? ServiceForm handles binding, but list mutation might not trigger UI update inside child unless we call StateHasChanged or replace list.
        // Better to create new list reference to trigger change detection in child
        model.Images = new List<string>(model.Images); 
    }

    private async Task SaveChanges(ServiceForm.ServiceFormModel submittedModel)
    {
         // Validation
        if (submittedModel.CategoryId == null && submittedModel.SubCategoryId == null)
        {
             await JS.InvokeVoidAsync("alert", "يرجى اختيار القسم والتصنيف");
             return;
        }

        isSaving = true;
        try
        {
            if (Id == 0)
            {
                var createCommand = new CreateServiceCommand
                {
                    Title = submittedModel.Title,
                    Description = submittedModel.Description,
                    Address = submittedModel.Address,
                    Price = submittedModel.Price,
                    Location = submittedModel.Location,
                    CategoryId = submittedModel.CategoryId, // Can be null in Model but CreateCommand might need logic
                    SubCategoryId = submittedModel.SubCategoryId,
                    CityId = submittedModel.CityId,
                    Images = submittedModel.Images,
                    Phone1 = submittedModel.Phone1,
                    Phone2 = null, // Form doesn't have phone 2 yet
                    WhatsApp = submittedModel.WhatsApp,
                    Facebook = submittedModel.Facebook,
                    Telegram = submittedModel.Telegram,
                    WorkDays = submittedModel.WorkDays,
                    WorkHours = submittedModel.WorkHours,
                    YouTubeUrl = submittedModel.YouTubeUrl
                };

                var result = await Api.CreateServiceAsync(createCommand);
                if (result.HasValue)
                {
                    await JS.InvokeVoidAsync("alert", "تم إضافة الخدمة بنجاح");
                    Navigation.NavigateTo("/provider/myservices");
                }
                else 
                {
                     await JS.InvokeVoidAsync("alert", "فشل إضافة الخدمة");
                }
            }
            else
            {
                var updateCommand = new UpdateServiceCommand
                {
                    Id = Id,
                    Title = submittedModel.Title,
                    Description = submittedModel.Description,
                    Address = submittedModel.Address,
                    Price = submittedModel.Price,
                    Location = submittedModel.Location,
                    CategoryId = submittedModel.CategoryId,
                    SubCategoryId = submittedModel.SubCategoryId,
                    CityId = submittedModel.CityId,
                    Images = submittedModel.Images,
                    Phone1 = submittedModel.Phone1,
                    Phone2 = null, 
                    WhatsApp = submittedModel.WhatsApp,
                    Facebook = submittedModel.Facebook,
                    Telegram = submittedModel.Telegram,
                    WorkDays = submittedModel.WorkDays,
                    WorkHours = submittedModel.WorkHours,
                    YouTubeUrl = submittedModel.YouTubeUrl
                };

                var result = await Api.UpdateServiceAsync(Id, updateCommand);
                if (result)
                {
                    await JS.InvokeVoidAsync("alert", "تم تعديل الخدمة بنجاح");
                    Navigation.NavigateTo("/provider/myservices");
                }
                else 
                {
                     await JS.InvokeVoidAsync("alert", "فشل تعديل الخدمة");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await JS.InvokeVoidAsync("alert", "حدث خطأ أثناء الحفظ");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void GoBack() => Navigation.NavigateTo("/provider/providerdashboard");
}

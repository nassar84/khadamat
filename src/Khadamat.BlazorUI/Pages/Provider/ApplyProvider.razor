@page "/provider/apply"
@layout Khadamat.BlazorUI.Layout.MainLayout
@using Khadamat.Application.DTOs
@using Khadamat.BlazorUI.Services
@using Khadamat.BlazorUI.Services.Auth
@inject ApiClient Api
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject Khadamat.BlazorUI.State.AppState AppState

<div class="request-page pb-5">
    <div class="header-banner text-white py-5 text-center mb-0" style="background: linear-gradient(135deg, #7c3aed, #4f46e5);">
        <div class="container animate-fade-in">
            <i class="fa-solid fa-briefcase fs-1 mb-3 floating"></i>
            <h1 class="fw-bold h2">انضم كـ مزود خدمة</h1>
            <p class="opacity-75">انضم إلى شبكة مزودي الخدمات المحترفين وابدأ في استقبال الطلبات</p>
        </div>
    </div>

    <div class="container mt-n5 position-relative z-2">
        @if (showSuccess)
        {
            <div class="glass-card p-5 text-center animate-up border-0 rounded-4 shadow-2xl">
                <div class="success-icon-wrapper mb-4">
                    <i class="fa-solid fa-circle-check text-success display-1"></i>
                </div>
                <h2 class="fw-bold mb-3">تم إرسال طلب الانضمام بنجاح!</h2>
                <p class="text-muted mb-4">فريقنا سيقوم بمراجعة مستنداتك وتفعيل حسابك قريباً.</p>
                <button class="btn btn-primary-premium rounded-pill px-5 py-2" @onclick='() => Navigation.NavigateTo("/profile")'>العودة للملف الشخصي</button>
            </div>
        }
        else
        {
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger rounded-4 mb-4 animate-fade-in d-flex align-items-center">
                    <i class="fa-solid fa-triangle-exclamation me-3 fs-4"></i>
                    <div>
                        <div class="fw-bold">حدث خطأ أثناء إرسال الطلب:</div>
                        <div>@errorMessage</div>
                    </div>
                </div>
            }

            <div class="form-container glass-card p-0 overflow-hidden shadow-2xl border-0 rounded-4 animate-up">
                <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />

                    <!-- Step 1: Business Info -->
                    <div class="form-section p-4 p-md-5">
                        <div class="d-flex align-items-center mb-4">
                            <div class="step-badge me-3">1</div>
                            <h4 class="fw-bold mb-0">بيانات النشاط</h4>
                        </div>

                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label fw-bold small">اسم النشاط التجاري</label>
                                <InputText @bind-Value="model.BusinessName" class="form-control premium-input" placeholder="اسم الشركة أو المؤسسة" />
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold small">نبذة عن النشاط (Bio)</label>
                                <InputTextArea @bind-Value="model.Bio" class="form-control premium-input" rows="3" placeholder="وصف موجز لخدماتك وخبراتك" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">المحافظة</label>
                                <select class="form-select premium-input" @onchange="OnGovernorateChanged">
                                    <option value="">اختر المحافظة...</option>
                                    @foreach (var gov in governorates)
                                    {
                                        <option value="@gov.Id">@gov.NameAr</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">المدينة</label>
                                @if (isLoadingCities)
                                {
                                    <div class="input-group">
                                        <select class="form-select premium-input" disabled>
                                            <option>جاري التحميل...</option>
                                        </select>
                                        <span class="input-group-text bg-white border-0"><div class="spinner-border spinner-border-sm text-primary"></div></span>
                                    </div>
                                }
                                else
                                {
                                    <InputSelect @bind-Value="model.CityId" class="form-select premium-input">
                                        <option value="0">اختر المدينة...</option>
                                        @foreach (var city in cities)
                                        {
                                            <option value="@city.Id">@city.NameAr</option>
                                        }
                                    </InputSelect>
                                }
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small">رقم التواصل</label>
                                <InputText @bind-Value="model.ContactNumber" class="form-control premium-input" placeholder="رقم الهاتف" />
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold small">الموقع الإلكتروني (اختياري)</label>
                                <InputText @bind-Value="model.WebsiteUrl" class="form-control premium-input" placeholder="https://example.com" />
                            </div>
                        </div>
                    </div>

                    <hr class="m-0 opacity-10">

                    <!-- Step 2: Documents -->
                    <div class="form-section p-4 p-md-5 bg-light-soft">
                        <div class="d-flex align-items-center mb-4">
                            <div class="step-badge me-3">2</div>
                            <h4 class="fw-bold mb-0">المستندات المطلوبة <span class="text-danger">*</span></h4>
                        </div>
                        <p class="text-muted small mb-4">يرجى رفع صور واضحة للمستندات التالية لتوثيق حسابك</p>

                        <div class="row g-4">
                            <!-- ID Card -->
                            <div class="col-md-6">
                                <div class="image-upload-wrapper text-center p-4 border-dashed rounded-4 bg-white position-relative overflow-hidden h-100">
                                    <h6 class="fw-bold mb-3">البطاقة الشخصية / الهوية</h6>
                                    
                                    @if (string.IsNullOrEmpty(model.IdCardImage))
                                    {
                                        <label class="btn btn-outline-primary rounded-pill px-4 py-2 cursor-pointer shadow-sm mt-3">
                                            <span><i class="fa-solid fa-upload me-2"></i> رفع الصورة</span>
                                            <InputFile OnChange="@((e) => HandleFileSelected(e, "ID"))" class="d-none" accept=".jpg,.jpeg,.png" />
                                        </label>
                                    }
                                    else
                                    {
                                        <div class="position-relative d-inline-block mt-3">
                                            <img src="@model.IdCardImage" class="rounded-3 shadow-lg border animate-scale-in" style="max-height: 150px; max-width: 100%; border: 4px solid white !important;" />
                                            <button type="button" class="btn btn-danger btn-sm rounded-circle position-absolute top-0 end-0 m-n2 shadow-lg" @onclick='() => model.IdCardImage = null'>
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    }
                                    @if (isUploadingId) { <div class="mt-2 text-primary small">جاري الرفع...</div> }
                                </div>
                            </div>

                            <!-- Certificate -->
                            <div class="col-md-6">
                                <div class="image-upload-wrapper text-center p-4 border-dashed rounded-4 bg-white position-relative overflow-hidden h-100">
                                    <h6 class="fw-bold mb-3">شهادة التسجيل / مزاولة المهنة</h6>
                                    
                                    @if (string.IsNullOrEmpty(model.CertificateImage))
                                    {
                                        <label class="btn btn-outline-primary rounded-pill px-4 py-2 cursor-pointer shadow-sm mt-3">
                                            <span><i class="fa-solid fa-upload me-2"></i> رفع الصورة</span>
                                            <InputFile OnChange="@((e) => HandleFileSelected(e, "CERT"))" class="d-none" accept=".jpg,.jpeg,.png" />
                                        </label>
                                    }
                                    else
                                    {
                                        <div class="position-relative d-inline-block mt-3">
                                            <img src="@model.CertificateImage" class="rounded-3 shadow-lg border animate-scale-in" style="max-height: 150px; max-width: 100%; border: 4px solid white !important;" />
                                            <button type="button" class="btn btn-danger btn-sm rounded-circle position-absolute top-0 end-0 m-n2 shadow-lg" @onclick='() => model.CertificateImage = null'>
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    }
                                     @if (isUploadingCert) { <div class="mt-2 text-primary small">جاري الرفع...</div> }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 p-md-5 pt-0 text-center">
                        <button type="submit" class="btn btn-primary-gradient px-5 py-3 rounded-pill shadow-lg w-100 mb-3 floating-btn-hover" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>جاري إرسال الطلب...</span>
                            }
                            else
                            {
                                <i class="fa-solid fa-paper-plane me-2 scale-hover"></i>
                                <span>إرسال طلب الانضمام</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        }
    </div>
</div>

<style>
    /* Reuse styles from CreateRequest.razor via CSS Isolation or copy */
    .request-page { background-color: #f8fafc; min-height: 100vh; }
    .mt-n5 { margin-top: -3.5rem !important; }
    .step-badge {
        width: 40px; height: 40px; background: linear-gradient(135deg, #7c3aed, #4f46e5); color: white;
        border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;
    }
    .border-dashed { border: 2px dashed #e2e8f0 !important; transition: all 0.3s; }
    .border-dashed:hover { border-color: #7c3aed !important; background-color: #f1f5f9 !important; }
    .bg-light-soft { background-color: #f8fafc; }
    .premium-input {
        padding: 0.85rem 1.25rem; border-radius: 1rem; border: 1px solid #e2e8f0; background-color: #fff;
    }
    .btn-primary-gradient {
        background: linear-gradient(135deg, #7c3aed, #4f46e5); border: none; color: white; font-weight: bold; font-size: 1.1rem;
    }
    .animate-scale-in { animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    @@keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .floating { animation: floatingAnim 3s ease-in-out infinite; }
</style>

@code {
    private ApplyProviderDto model = new();
    private bool isSaving = false;
    private bool isUploadingId = false;
    private bool isUploadingCert = false;
    private bool showSuccess = false;
    private string? errorMessage;
    private bool isLoadingCities = false;
    
    private List<GovernorateDto> governorates = new();
    private List<CityDto> cities = new();

    protected override async Task OnInitializedAsync()
    {
        if (!AppState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login?returnUrl=/provider/apply");
            return;
        }

        try 
        {
            governorates = await Api.GetGovernoratesAsync();
            
            // Pre-fill user data
            var profileResult = await AuthService.GetProfileAsync();
            if (profileResult?.Success == true && profileResult.Data != null)
            {
                var p = profileResult.Data;
                model.ContactNumber = p.PhoneNumber ?? string.Empty;
                model.CityId = p.CityId ?? 0;
                
                if (p.GovernorateId.HasValue)
                {
                    cities = await Api.GetCitiesAsync(p.GovernorateId.Value);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
    }

    private async Task OnGovernorateChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val) && val > 0)
        {
            isLoadingCities = true;
            StateHasChanged();
            
            try 
            {
                cities = await Api.GetCitiesAsync(val);
            }
            finally 
            {
                isLoadingCities = false;
                model.CityId = 0;
                StateHasChanged();
            }
        }
        else
        {
            cities.Clear();
            model.CityId = 0;
            StateHasChanged();
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e, string type)
    {
        var file = e.File;
        // Basic upload logic similar to CreateRequest
        try 
        {
            if (type == "ID") isUploadingId = true; else isUploadingCert = true;
            
            var format = "image/png";
            var resizedFile = await file.RequestImageFileAsync(format, 800, 600);
            var buffer = new byte[resizedFile.Size];
            using var stream = resizedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            await stream.ReadAsync(buffer);
            var base64 = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
            
            if (type == "ID") model.IdCardImage = base64;
            else model.CertificateImage = base64;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Error uploading image: " + ex.Message);
        }
        finally
        {
            if (type == "ID") isUploadingId = false; else isUploadingCert = false;
        }
    }

    private async Task HandleSubmit()
    {
        errorMessage = null;

        if (string.IsNullOrEmpty(model.BusinessName) || model.CityId == 0 || string.IsNullOrEmpty(model.ContactNumber))
        {
            errorMessage = "يرجى تعبئة جميع البيانات الأساسية";
            return;
        }

        if (string.IsNullOrEmpty(model.IdCardImage) || string.IsNullOrEmpty(model.CertificateImage))
        {
            errorMessage = "يرجى رفع المستندات المطلوبة (البطاقة والشهادة)";
            return;
        }

        isSaving = true;
        try
        {
            var success = await Api.ApplyProviderAsync(model);
            if (success)
            {
                showSuccess = true;
            }
            else
            {
                errorMessage = "فشل في إرسال الطلب، قد تكون مسجلاً بالفعل.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error: " + ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }
}

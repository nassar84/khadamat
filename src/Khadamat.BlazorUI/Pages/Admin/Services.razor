@page "/admin/services"
@using Khadamat.Application.DTOs
@using Khadamat.BlazorUI.Services
@using Khadamat.BlazorUI.Services.Admin
@using Khadamat.BlazorUI.Components.Common
@using Khadamat.BlazorUI.Shared.Components
@using Khadamat.Application.Features.Services.Commands
@inject ApiClient Api
@inject IAdminService AdminService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>استكشاف الخدمات شجرياً</PageTitle>

<div class="px-3 pt-3 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="/admin" class="text-decoration-none text-muted">لوحة المدير</a></li>
                    <li class="breadcrumb-item active">الخدمات</li>
                </ol>
            </nav>
            <h3 class="fw-bold mb-0">هيكل الخدمات (شجري)</h3>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary rounded-pill px-4" @onclick="() => isExpandedAll = !isExpandedAll">
                <i class="fa-solid @(isExpandedAll ? "fa-compress" : "fa-expand") me-2"></i> @(isExpandedAll ? "طي الكل" : "توسيع الكل")
            </button>
            <button class="btn btn-primary-premium rounded-pill px-4" @onclick="NavigateToCreateService">
                <i class="fa-solid fa-plus me-2"></i> إضافة خدمة
            </button>
        </div>
    </div>

    <div class="glass-card p-4">
        @if (isLoading)
        {
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">جاري بناء هيكل الخدمات...</p>
            </div>
        }
        else if (!treeNodes.Any())
        {
            <div class="text-center p-5 text-muted">
                <i class="fa-solid fa-server fs-1 mb-3 opacity-25"></i>
                <p>لا توجد بيانات متاحة</p>
            </div>
        }
        else
        {
            <div class="tree-container">
                @foreach (var node in treeNodes)
                {
                    <TreeViewItem TItem="ServiceTreeNode" 
                                 Item="node" 
                                 TextSelector="@(n => n.Name)"
                                 ChildrenSelector="@(n => n.Children)"
                                 IsInitiallyExpanded="isExpandedAll">
                        <IconTemplate Context="n">
                            @if (n.Level == 0) { <i class="fa-solid fa-layer-group text-primary"></i> }
                            else if (n.Level == 1) { <i class="fa-solid fa-folder text-warning"></i> }
                            else if (n.Level == 2) { <i class="fa-solid fa-tag text-info"></i> }
                            else { <i class="fa-solid fa-briefcase text-success"></i> }
                        </IconTemplate>
                        <BadgeTemplate Context="n">
                            @if (n.Level < 3 && n.ChildrenCount > 0)
                            {
                                <span class="badge rounded-pill bg-light text-dark border ms-2 x-small">@n.ChildrenCount</span>
                            }
                            @if (n.Level == 3 && !n.IsApproved)
                            {
                                <span class="badge rounded-pill bg-warning text-dark border ms-2 x-small">قيد الانتظار</span>
                            }
                        </BadgeTemplate>
                        <ActionsTemplate Context="n">
                            @if (n.Level == 3)
                            {
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-light border text-primary" title="تعديل" @onclick:stopPropagation="true" @onclick="() => OpenEditService(n)">
                                        <i class="fa-solid fa-pen x-small"></i>
                                    </button>
                                    @if (!n.IsApproved)
                                    {
                                        <button class="btn btn-sm btn-light border text-success" title="اعتماد" @onclick:stopPropagation="true" @onclick="() => Approve(n)">
                                            <i class="fa-solid fa-check x-small"></i>
                                        </button>
                                    }
                                    @if (n.IsApproved)
                                    {
                                        <button class="btn btn-sm btn-light border text-warning" title="إلغاء اعتماد" @onclick:stopPropagation="true" @onclick="() => Reject(n)">
                                            <i class="fa-solid fa-xmark x-small"></i>
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-light border text-danger" title="حذف" @onclick:stopPropagation="true" @onclick="() => DeleteService(n)">
                                        <i class="fa-solid fa-trash x-small"></i>
                                    </button>
                                </div>
                            }
                        </ActionsTemplate>
                    </TreeViewItem>
                }
            </div>
        }
    </div>
</div>

@if (showEditModal && serviceFormModel != null)
{
    <div class="modal-overlay" @onclick="() => showEditModal = false">
        <div class="glass-card p-4 rounded-4 w-100 mx-3 animate-pop" style="max-width: 800px; max-height: 90vh; overflow-y: auto;" @onclick:stopPropagation="true">
            <ServiceForm Model="@serviceFormModel" 
                        MainCategories="@mainCategories"
                        Governorates="@governorates"
                        IsSaving="@isSaving"
                        ShowTitle="true"
                        Id="@(editServiceId)"
                        OnSave="SaveChanges"
                        OnCancel="() => showEditModal = false" />
        </div>
    </div>
}

<style>
    .tree-container {
        max-width: 900px;
    }
    .modal-overlay {
        position: fixed; inset: 0; z-index: 2000;
        background: rgba(0,0,0,0.4);
        backdrop-filter: blur(5px);
        display: flex; align-items: center; justify-content: center;
    }
    .animate-pop {
        animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @@keyframes pop {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
</style>

@code {
    private List<ServiceTreeNode> treeNodes = new();
    private bool isLoading = true;
    private bool isExpandedAll = false;
    
    // For ServiceForm
    private List<MainCategoryDto> mainCategories = new();
    private List<GovernorateDto> governorates = new();
    private ServiceForm.ServiceFormModel? serviceFormModel;
    private int editServiceId;
    private bool showEditModal = false;
    private bool isSaving = false;

    public class ServiceTreeNode
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int Level { get; set; } // 0: Main, 1: Category, 2: SubCategory, 3: Service
        public bool IsApproved { get; set; }
        public int ChildrenCount => Children.Count;
        public List<ServiceTreeNode> Children { get; set; } = new();
    }

    protected override async Task OnInitializedAsync()
    {
        // Load initial data for form
        try 
        {
            mainCategories = await Api.GetMainCategoriesAsync();
            governorates = await Api.GetGovernoratesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading lookups: {ex.Message}");
        }

        await LoadTree();
    }

    private async Task LoadTree()
    {
        isLoading = true;
        treeNodes.Clear();
        
        try 
        {
            var mainCats = await Api.GetMainCategoriesAsync(); // Refresh in case changed
            var allServicesResult = await Api.GetServicesAsync(pageSize: 1000); // 1000 is optimization cap
            var allServices = allServicesResult.Items;

            foreach (var mc in mainCats)
            {
                var mcNode = new ServiceTreeNode { Id = mc.Id, Name = mc.Name, Level = 0 };
                
                var cats = await Api.GetCategoriesByMainIdAsync(mc.Id);
                foreach (var cat in cats)
                {
                    var catNode = new ServiceTreeNode { Id = cat.Id, Name = cat.Name, Level = 1 };
                    
                    var subs = await Api.GetSubCategoriesByCategoryIdAsync(cat.Id);
                    foreach (var sub in subs)
                    {
                        var subNode = new ServiceTreeNode { Id = sub.Id, Name = sub.Name, Level = 2 };
                        
                        // Add services
                        var subServices = allServices.Where(s => s.SubCategoryId == sub.Id);
                        foreach (var s in subServices)
                        {
                            subNode.Children.Add(new ServiceTreeNode 
                            { 
                                Id = s.Id, 
                                Name = s.Title, 
                                Level = 3, 
                                IsApproved = s.IsApproved 
                            });
                        }

                        if (subNode.ChildrenCount > 0)
                            catNode.Children.Add(subNode);
                    }
                    
                    if (catNode.ChildrenCount > 0)
                        mcNode.Children.Add(catNode);
                }
                
                if (mcNode.ChildrenCount > 0)
                    treeNodes.Add(mcNode);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading service tree: {ex.Message}");
        }
        
        isLoading = false;
    }

    private void NavigateToCreateService()
    {
        Navigation.NavigateTo("/provider/create-service");
    }

    private void ViewService(int id)
    {
        Navigation.NavigateTo($"/service/{id}");
    }

    private async Task Approve(ServiceTreeNode node)
    {
        try
        {
            await AdminService.ApproveService(node.Id);
            node.IsApproved = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error approving service: {ex.Message}");
        }
    }

    private async Task Reject(ServiceTreeNode node)
    {
        try
        {
            await AdminService.RejectService(node.Id);
            node.IsApproved = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rejecting service: {ex.Message}");
        }
    }

    private async Task DeleteService(ServiceTreeNode node)
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"هل أنت متأكد من حذف الخدمة: {node.Name}؟")) return;
        
        try
        {
            await AdminService.RejectService(node.Id); // Or Delete endpoint if exists
            await LoadTree();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting service: {ex.Message}");
        }
    }

    private async Task OpenEditService(ServiceTreeNode node)
    {
        try 
        {
            var service = await Api.GetServiceByIdAsync(node.Id);
            if (service != null)
            {
                editServiceId = service.Id;
                serviceFormModel = new ServiceForm.ServiceFormModel
                {
                    Title = service.Title,
                    Description = service.Description,
                    Price = service.Price,
                    Address = service.Address,
                    CityId = service.CityId,
                    Location = service.Location,
                    CategoryId = service.CategoryId,
                    SubCategoryId = service.SubCategoryId,
                    Phone1 = service.Phone1,
                    WhatsApp = service.WhatsApp,
                    Facebook = service.Facebook,
                    Telegram = service.Telegram,
                    WorkDays = service.WorkDays,
                    WorkHours = service.WorkHours,
                    YouTubeUrl = service.YouTubeUrl,
                    Images = service.Images ?? new List<string>()
                };
                showEditModal = true;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "خطأ في تحميل بيانات الخدمة: " + ex.Message);
        }
    }

    private async Task SaveChanges(ServiceForm.ServiceFormModel model)
    {
        isSaving = true;
        try
        {
            var updateDto = new UpdateServiceCommand
            {
                Title = model.Title,
                Description = model.Description,
                Price = model.Price,
                Address = model.Address,
                CityId = model.CityId,
                Location = model.Location,
                CategoryId = model.CategoryId,
                SubCategoryId = model.SubCategoryId,
                Phone1 = model.Phone1,
                WhatsApp = model.WhatsApp,
                Facebook = model.Facebook,
                Telegram = model.Telegram,
                WorkDays = model.WorkDays,
                WorkHours = model.WorkHours,
                YouTubeUrl = model.YouTubeUrl,
                Images = model.Images
            };

            await AdminService.UpdateService(editServiceId, new ServiceDto 
            {
                // Mapping back to ServiceDto because AdminService.UpdateService takes Interface DTO usually or Command?
                // Checking previous code: AdminService.UpdateService(id, ServiceDto)
                Id = editServiceId,
                Title = model.Title,
                Description = model.Description,
                Price = model.Price,
                Address = model.Address,
                CityId = model.CityId,
                Location = model.Location,
                CategoryId = model.CategoryId,
                SubCategoryId = model.SubCategoryId,
                Phone1 = model.Phone1,
                WhatsApp = model.WhatsApp,
                Facebook = model.Facebook,
                Telegram = model.Telegram,
                WorkDays = model.WorkDays,
                WorkHours = model.WorkHours,
                YouTubeUrl = model.YouTubeUrl,
                Images = model.Images
            });
            
            await JS.InvokeVoidAsync("alert", "تم حفظ التغييرات بنجاح");
            showEditModal = false;
            await LoadTree();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "خطأ في حفظ البيانات: " + ex.Message);
        }
        finally
        {
            isSaving = false;
        }
    }
}

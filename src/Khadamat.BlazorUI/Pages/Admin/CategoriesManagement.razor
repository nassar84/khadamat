@page "/admin/categories"
@using Khadamat.Application.DTOs
@using Khadamat.BlazorUI.Services
@using Khadamat.BlazorUI.Components.Common
@using Khadamat.BlazorUI.Shared.Components
@inject ApiClient Api
@inject IJSRuntime JS

<div class="px-3 pt-3 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="/admin" class="text-decoration-none text-muted">لوحة المدير</a></li>
                    <li class="breadcrumb-item active">التصنيفات</li>
                </ol>
            </nav>
            <h3 class="fw-bold mb-0">إدارة التصنيفات الشجرية</h3>
        </div>
        <button class="btn btn-primary-premium rounded-pill px-4" @onclick="() => AddItem(null)">
            <i class="fa-solid fa-plus me-2"></i> إضافة تصنيف رئيسي
        </button>
    </div>

    <div class="glass-card p-4">
        @if (isLoading)
        {
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">جاري تحميل الهيكل الشجري...</p>
            </div>
        }
        else if (!treeNodes.Any())
        {
            <div class="text-center p-5 text-muted">
                <i class="fa-solid fa-folder-open fs-1 mb-3 opacity-25"></i>
                <p>لا توجد تصنيفات حالياً</p>
            </div>
        }
        else
        {
            <div class="tree-container">
                @foreach (var node in treeNodes)
                {
                    <TreeViewItem TItem="CategoryNode" 
                                 Item="node" 
                                 TextSelector="@(n => n.Name)"
                                 ChildrenSelector="@(n => n.Children)"
                                 IsInitiallyExpanded="false">
                        <IconTemplate Context="n">
                            @if (n.Level == 0) { <i class="fa-solid fa-layer-group text-primary"></i> }
                            else if (n.Level == 1) { <i class="fa-solid fa-folder text-warning"></i> }
                            else { <i class="fa-solid fa-tag text-info"></i> }
                        </IconTemplate>
                        <ActionsTemplate Context="n">
                            @if (n.Level < 2)
                            {
                                <button class="btn btn-sm btn-light border text-success" title="إضافة" @onclick:stopPropagation="true" @onclick="() => AddItem(n)">
                                    <i class="fa-solid fa-plus x-small"></i>
                                </button>
                            }
                            <button class="btn btn-sm btn-light border" title="تعديل" @onclick:stopPropagation="true" @onclick="() => EditItem(n)">
                                <i class="fa-solid fa-pen x-small"></i>
                            </button>
                            <button class="btn btn-sm btn-light border text-danger" title="حذف" @onclick:stopPropagation="true" @onclick="() => DeleteItem(n)">
                                <i class="fa-solid fa-trash x-small"></i>
                            </button>
                        </ActionsTemplate>
                    </TreeViewItem>
                }
            </div>
        }
    </div>
</div>

<!-- Shared Category Form -->
<CategoryForm Show="showModal" 
              IsEditing="isEditing" 
              Model="categoryModel" 
              OnSave="HandleSave" 
              OnCancel="() => showModal = false" />

<!-- Shared Confirm Dialog -->
@if (showDeleteConfirm && nodeToDelete != null)
{
    <ConfirmDialog Show="true" 
                   Title="حذف التصنيف" 
                   Message="@($"هل أنت متأكد من حذف {nodeToDelete.Name}؟ سيتم حذف جميع التصنيفات التابعة له أيضاً.")"
                   OnConfirm="HandleDeleteConfirm"
                   OnCancel="() => { showDeleteConfirm = false; nodeToDelete = null; }" />
}

@code {
    private List<CategoryNode> treeNodes = new();
    private bool isLoading = true;

    // Modal State
    private bool showModal = false;
    private bool isEditing = false;
    private CategoryNode? modalNode;
    private CategoryForm.CategoryFormModel categoryModel = new();

    // Delete State
    private bool showDeleteConfirm = false;
    private CategoryNode? nodeToDelete;

    public class CategoryNode
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int Level { get; set; } // 0: Main, 1: Category, 2: SubCategory
        public int? ParentId { get; set; }
        public List<CategoryNode> Children { get; set; } = new();
    }

    protected override async Task OnInitializedAsync() => await LoadTree();

    private async Task LoadTree()
    {
        isLoading = true;
        treeNodes.Clear();
        try 
        {
            var mainCats = await Api.GetMainCategoriesAsync();
            foreach (var mc in mainCats)
            {
                var mcNode = new CategoryNode { Id = mc.Id, Name = mc.Name, Level = 0 };
                var cats = await Api.GetCategoriesByMainIdAsync(mc.Id);
                foreach (var cat in cats)
                {
                    var catNode = new CategoryNode { Id = cat.Id, Name = cat.Name, Level = 1, ParentId = mc.Id };
                    var subs = await Api.GetSubCategoriesByCategoryIdAsync(cat.Id);
                    foreach (var sub in subs)
                    {
                        catNode.Children.Add(new CategoryNode { Id = sub.Id, Name = sub.Name, Level = 2, ParentId = cat.Id });
                    }
                    mcNode.Children.Add(catNode);
                }
                treeNodes.Add(mcNode);
            }
        }
        finally { isLoading = false; }
    }

    private void AddItem(CategoryNode? parent)
    {
        modalNode = parent == null ? new CategoryNode { Level = 0 } : new CategoryNode { Level = parent.Level + 1, ParentId = parent.Id };
        isEditing = false;
        categoryModel = new CategoryForm.CategoryFormModel 
        { 
            Level = modalNode.Level, 
            ParentId = modalNode.ParentId 
        };
        showModal = true;
    }

    private async Task EditItem(CategoryNode node)
    {
        modalNode = node;
        isEditing = true;
        categoryModel = new CategoryForm.CategoryFormModel
        {
            Id = node.Id,
            Name = node.Name,
            ParentId = node.ParentId
        };

        if (node.Level == 0)
        {
            var detailed = (await Api.GetMainCategoriesAsync()).FirstOrDefault(m => m.Id == node.Id);
            if (detailed != null)
            {
                categoryModel.Icon = detailed.Icon;
                categoryModel.Color = detailed.Color;
                categoryModel.ImageUrl = detailed.ImageUrl;
                categoryModel.DisplayOrder = detailed.DisplayOrder;
            }
        }
        showModal = true;
    }

    private async Task HandleSave(CategoryForm.CategoryFormModel model)
    {
        if (isEditing)
        {
            if (modalNode!.Level == 0)
                await Api.UpdateMainCategoryAsync(model.Id, new MainCategoryDto { Id = model.Id, Name = model.Name, Icon = model.Icon, Color = model.Color, DisplayOrder = model.DisplayOrder, ImageUrl = model.ImageUrl });
            else if (modalNode.Level == 1)
                await Api.UpdateCategoryAsync(model.Id, new CategoryDto { Id = model.Id, Name = model.Name, MainCategoryId = model.ParentId ?? 0 });
            else
                await Api.UpdateSubCategoryAsync(model.Id, new SubCategoryDto { Id = model.Id, Name = model.Name, CategoryId = model.ParentId ?? 0 });
        }
        else
        {
            if (modalNode!.Level == 0)
                await Api.CreateMainCategoryAsync(new MainCategoryDto { Name = model.Name, Icon = model.Icon, Color = model.Color, DisplayOrder = model.DisplayOrder, ImageUrl = model.ImageUrl });
            else if (modalNode.Level == 1)
                await Api.CreateCategoryAsync(new CategoryDto { Name = model.Name, MainCategoryId = modalNode.ParentId ?? 0 });
            else
                await Api.CreateSubCategoryAsync(new SubCategoryDto { Name = model.Name, CategoryId = modalNode.ParentId ?? 0 });
        }

        showModal = false;
        await LoadTree();
    }

    private void DeleteItem(CategoryNode node)
    {
        nodeToDelete = node;
        showDeleteConfirm = true;
    }

    private async Task HandleDeleteConfirm()
    {
        if (nodeToDelete == null) return;
        try 
        {
            if (nodeToDelete.Level == 0) await Api.DeleteMainCategoryAsync(nodeToDelete.Id);
            else if (nodeToDelete.Level == 1) await Api.DeleteCategoryAsync(nodeToDelete.Id);
            else await Api.DeleteSubCategoryAsync(nodeToDelete.Id);
            
            showDeleteConfirm = false;
            nodeToDelete = null;
            await LoadTree();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "خطأ في الحذف: " + ex.Message);
        }
    }
}


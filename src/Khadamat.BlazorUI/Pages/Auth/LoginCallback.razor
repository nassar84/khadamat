@page "/login-callback"
@inject NavigationManager Navigation
@inject Khadamat.BlazorUI.Services.Auth.IAuthService AuthService
@inject Khadamat.BlazorUI.State.AppState AppState

<div class="d-flex flex-column align-items-center justify-content-center vh-100">
    <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h4 class="text-muted">جاري تسجيل الدخول...</h4>
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">
            @errorMessage
            <br />
            <a href="/login" class="btn btn-sm btn-outline-danger mt-2">العودة لتسجيل الدخول</a>
        </div>
    }
</div>

@code {
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryRaw = uri.Query.TrimStart('?');
        var queryDict = new Dictionary<string, string>();
        
        if (!string.IsNullOrEmpty(queryRaw))
        {
            foreach (var part in queryRaw.Split('&'))
            {
                var kvp = part.Split(new[] { '=' }, 2);
                if (kvp.Length == 2)
                {
                    queryDict[Uri.UnescapeDataString(kvp[0])] = Uri.UnescapeDataString(kvp[1]);
                }
            }
        }

        if (queryDict.TryGetValue("error", out var error))
        {
            errorMessage = $"فشل تسجيل الدخول: {error}";
            return;
        }

        queryDict.TryGetValue("token", out var token);
        queryDict.TryGetValue("refreshToken", out var refreshToken);

        if (!string.IsNullOrEmpty(token) && !string.IsNullOrEmpty(refreshToken))
        {
            try
            {
                var success = await AuthService.LoginWithToken(token, refreshToken);
                if (success)
                {
                    // Fetch profile to update AppState
                    await AuthService.GetProfileAsync();
                    
                    Navigation.NavigateTo("/", forceLoad: true);
                }
                else
                {
                    errorMessage = "فشل التحقق من التوكن.";
                }
            }
            catch (Exception ex)
            {
                errorMessage = "حدث خطأ غير متوقع.";
                Console.WriteLine(ex);
            }
        }
        else
        {
            errorMessage = "لم يتم العثور على توكن تسجيل الدخول.";
        }
    }
}

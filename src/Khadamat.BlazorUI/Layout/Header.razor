@using Khadamat.BlazorUI.State
@using Khadamat.BlazorUI.Services.Auth
@inject AppState State
@inject IJSRuntime JSRuntime
@inject IAuthService AuthService
@inject NavigationManager Navigation
@implements IDisposable

<header class="app-header-premium">
    <div class="header-start">
        <div class="search-container-glass">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" placeholder="ابحث عن خدمات، صنايعية، أو طلبات..." class="search-input" />
            <kbd class="search-shortcut">⌘K</kbd>
        </div>
    </div>

    <div class="header-center d-none d-xl-flex">
        <div class="status-indicator">
            <div class="status-dot @(State.IsProviderMode ? "provider" : "client")"></div>
            <span class="status-text">@(State.IsProviderMode ? "وضع المزود نشط" : "وضع العميل")</span>
        </div>
    </div>

    <div class="header-end">
        <!-- Theme Toggle -->
        <div id="themeToggle" class="theme-minimal-toggle" @onclick="ToggleThemeMenu">
            <i class="fa-solid fa-palette"></i>
            <div class="theme-popover @(isThemeMenuOpen ? "show" : "")">
                 <div class="theme-grid-minimal">
                    <button class="theme-dot default @(State.CurrentTheme == "default" ? "active" : "")" @onclick='() => HandleSetTheme("default")' title="أورورا"></button>
                    <button class="theme-dot sunset @(State.CurrentTheme == "sunset" ? "active" : "")" @onclick='() => HandleSetTheme("sunset")' title="غروب"></button>
                    <button class="theme-dot ocean @(State.CurrentTheme == "ocean" ? "active" : "")" @onclick='() => HandleSetTheme("ocean")' title="محيطي"></button>
                    <button class="theme-dot forest @(State.CurrentTheme == "forest" ? "active" : "")" @onclick='() => HandleSetTheme("forest")' title="غابة"></button>
                    <button class="theme-dot lavender @(State.CurrentTheme == "lavender" ? "active" : "")" @onclick='() => HandleSetTheme("lavender")' title="لافندر"></button>
                    <button class="theme-dot royal @(State.CurrentTheme == "royal" ? "active" : "")" @onclick='() => HandleSetTheme("royal")' title="ملكي"></button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="icon-action-btn message-btn" @onclick='() => Navigation.NavigateTo("/user/messages")'>
            <i class="fa-solid fa-envelope"></i>
            @if (State.HasUnreadMessages)
            {
                <span class="pulse-badge danger">!</span>
            }
        </div>

        <!-- Notifications -->
        <div class="icon-action-btn notification-btn" @onclick='() => Navigation.NavigateTo("/user/notifications")'>
            <i class="fa-solid fa-bell"></i>
            @if (State.HasUnreadNotifications)
            {
                <span class="pulse-badge">@State.NotificationCount</span>
            }
        </div>

        <!-- User Dropdown -->
        <AuthorizeView>
            <Authorized>
                <div id="userDropdown" class="user-dropdown-wrapper">
                    <div class="user-trigger" @onclick="ToggleUserMenu">
                        <div class="avatar-wrapper">
                            <img src="@State.UserImageUrl" class="header-avatar-img" alt="User" />
                            <div class="online-indicator"></div>
                        </div>
                        <div class="user-meta d-none d-md-flex">
                            <span class="user-name-txt">@context.User.Identity?.Name</span>
                            <span class="user-role-txt">
                                @(context.User.IsInRole("SuperAdmin") ? "مدير خارق" : 
                                  context.User.IsInRole("SystemAdmin") ? "مدير نظام" : 
                                  State.IsProvider ? "مزود خدمة" : "عميل")
                            </span>
                        </div>
                        <i class="fa-solid fa-chevron-down ms-2 chevron-icon @(isUserMenuOpen ? "rotate" : "")"></i>
                    </div>

                    <div class="user-glass-menu @(isUserMenuOpen ? "show" : "")">
                        <div class="menu-header">
                            <img src="@State.UserImageUrl" class="menu-avatar" />
                            <div class="menu-user-info">
                                <div class="menu-name">@context.User.Identity?.Name</div>
                                <div class="menu-email">@context.User.FindFirst("email")?.Value</div>
                            </div>
                        </div>
                        <div class="menu-divider"></div>
                        <a href="/profile" class="menu-link" @onclick="CloseMenus">
                            <i class="fa-solid fa-circle-user"></i>
                            <span>الملف الشخصي</span>
                        </a>
                        <a href="/settings" class="menu-link" @onclick="CloseMenus">
                            <i class="fa-solid fa-gear"></i>
                            <span>الإعدادات</span>
                        </a>
                        @if (State.IsProvider)
                        {
                            <div class="menu-link mode-switch" @onclick="ToggleProviderMode">
                                <i class="fa-solid fa-repeat"></i>
                                <span>@(State.IsProviderMode ? "تبديل لوضع العميل" : "تبديل لوضع المزود")</span>
                            </div>
                        }
                        <AuthorizeView Roles="SystemAdmin,SuperAdmin" Context="adminContext">
                            <a href="/admin" class="menu-link admin-link" @onclick="CloseMenus">
                                <i class="fa-solid fa-shield-halved"></i>
                                <span>لوحة الإدارة</span>
                            </a>
                        </AuthorizeView>
                        <div class="menu-divider"></div>
                        <div class="menu-link logout-link" @onclick="HandleLogout">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <span>تسجيل الخروج</span>
                        </div>
                    </div>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="auth-actions-minimal">
                    <a href="/login" class="login-link-minimal">تسجيل الدخول</a>
                    <a href="/register" class="register-btn-premium">إنشاء حساب</a>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </div>
</header>
<CategoryMarquee />
@if (isUserMenuOpen || isThemeMenuOpen)
{
    <div class="menu-backdrop" @onclick="CloseMenus"></div>
}

<style>
    .menu-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 900;
        cursor: default;
        background: transparent;
    }
    
    .user-glass-menu, .theme-popover {
        z-index: 1002 !important; 
    }
    
    .user-dropdown-wrapper, .theme-minimal-toggle {
        position: relative;
        z-index: 1003 !important;
    }
</style>

@code {
    private bool isThemeMenuOpen = false;
    private bool isUserMenuOpen = false;

    protected override void OnInitialized()
    {
        State.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("document.body.setAttribute", "data-theme", State.CurrentTheme);
        }
    }

    public void Dispose()
    {
        State.OnChange -= StateHasChanged;
    }



    private void ToggleThemeMenu() 
    {
        isThemeMenuOpen = !isThemeMenuOpen;
        if (isThemeMenuOpen) isUserMenuOpen = false;
    }

    private void ToggleUserMenu() 
    {
        isUserMenuOpen = !isUserMenuOpen;
        if (isUserMenuOpen) isThemeMenuOpen = false;
    }

    private void CloseMenus()
    {
        isThemeMenuOpen = false;
        isUserMenuOpen = false;
    }



    private async Task HandleSetTheme(string theme)
    {
        State.SetTheme(theme);
        await JSRuntime.InvokeVoidAsync("document.body.setAttribute", "data-theme", theme);
        isThemeMenuOpen = false;
    }

    private async Task HandleLogout()
    {
        CloseMenus();
        await AuthService.Logout();
        Navigation.NavigateTo("/login");
    }

    private void ToggleProviderMode()
    {
        CloseMenus();
        State.IsProviderMode = !State.IsProviderMode;
        if (State.IsProviderMode) 
        {
            Navigation.NavigateTo("provider/dashboard");
        }
        else 
        {
             Navigation.NavigateTo("/");
        }
    }
}


@inherits LayoutComponentBase
@implements IDisposable

<div class="khadamat-app">
    <Sidebar />
    
    <div class="app-main-view">
        <Header />
        
        <main class="app-content">
            @if (ShowPromotionalContent)
            {
                <CategoryMarquee />
            }
            <div class="content-wrapper">
                @if (ShowHeroAds)
                {
                    <HeroAds />
                }
                @Body
            </div>
        </main>

        <Footer />
    </div>

    <BottomNav />
</div>

<style>
    .khadamat-app {
        display: flex;
        flex-direction: row;
        min-height: 100vh;
        width: 100%;
        background: transparent;
        position: relative;
    }

    .app-main-view {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        overflow-y: auto;
        position: relative;
    }

    @@media (max-width: 991px) {
        .khadamat-app {
            flex-direction: column;
        }
        .app-main-view {
            width: 100%;
        }
    }
</style>

@inject NavigationManager Navigation
@inject Khadamat.BlazorUI.Services.Auth.IAuthService AuthService
@inject Khadamat.BlazorUI.State.AppState AppState
@inject Khadamat.BlazorUI.Services.ApiClient Api
@inject IJSRuntime JS

@code {
    private bool IsAdminPage => Navigation.Uri.Contains("/admin", StringComparison.OrdinalIgnoreCase);
    private bool IsProfilePage => Navigation.Uri.Contains("/profile", StringComparison.OrdinalIgnoreCase) || Navigation.Uri.Contains("/settings", StringComparison.OrdinalIgnoreCase);
    private bool IsProviderPage => Navigation.Uri.Contains("/provider/", StringComparison.OrdinalIgnoreCase);
    private bool IsHomePage => Navigation.Uri.EndsWith("/") || Navigation.Uri.EndsWith("/index");

    private bool ShowPromotionalContent => !IsAdminPage && !IsProfilePage && !IsProviderPage;
    private bool ShowHeroAds => IsHomePage;

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += HandleLocationChanged;
        // Load global settings
        try
        {
            var settingsResult = await Api.GetSettingsAsync();
            if (settingsResult?.Success == true && settingsResult.Data != null)
            {
                AppState.AppName = settingsResult.Data.ApplicationName;
                AppState.AppLogo = settingsResult.Data.LogoUrl;
                AppState.PrimaryColor = settingsResult.Data.PrimaryColor;
                AppState.SecondaryColor = settingsResult.Data.SecondaryColor;
                AppState.TriggerStateChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading settings: {ex.Message}");
        }

        if (AppState.IsAuthenticated && !AppState.IsProfileComplete)
        {
            try
            {
                var profile = await AuthService.GetProfileAsync();
                if (profile?.Success == true && profile.Data != null)
                {
                    AppState.UserName = profile.Data.UserName;
                    AppState.IsProvider = profile.Data.IsProvider;
                    AppState.CityId = profile.Data.CityId;
                    AppState.GovernorateId = profile.Data.GovernorateId;
                    AppState.PhoneNumber = profile.Data.PhoneNumber;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error syncing profile: {ex.Message}");
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(AppState.PrimaryColor))
        {
            try
            {
                await JS.InvokeVoidAsync("applyThemeColors", AppState.PrimaryColor, AppState.SecondaryColor);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error applying theme colors: {ex.Message}");
            }
        }
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e) => StateHasChanged();

    public void Dispose()
    {
        Navigation.LocationChanged -= HandleLocationChanged;
    }
}
